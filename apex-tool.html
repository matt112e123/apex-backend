<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEX Tool Platform - Professional Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for a clean, professional look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Fonts for the new Chart Component -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto+Mono:400;700&display=swap" rel="stylesheet" />
    <!-- React and Chart.js CDNs for the new Chart Component -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Dark background for the entire page */
            background-color: #1A1A1A;
            color: #E0E0E0; /* Light gray text */
            line-height: 1.4; /* Reduced line height */
            margin: 0;
            padding: 0;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2D2D2D; /* Darker track */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #555555; /* Grayish thumb */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #777777; /* Lighter gray on hover */
        }

        /* Global text selection styling for better readability */
        ::selection {
            background: #2196F3; /* Blue highlight */
            color: #FFFFFF; /* White text on selection */
        }
        ::-moz-selection {
            background: #2196F3;
            color: #FFFFFF;
        }

        /* Specific styles for chart colors and accents */
        .accent-green { color: #00C853; } /* Vibrant green for positive */
        .accent-red { color: #D50000; } /* Vibrant red for negative */
        .accent-blue { color: #2196F3; } /* Bright blue for links/highlights */
        .panel-bg { background-color: #252525; } /* Slightly lighter dark for panels */
        .input-bg { background-color: #1A1A1A; } /* Darkest for input fields */
        .border-color { border-color: #3A3A3A; } /* Subtle border for panels/inputs */

        /* Gradient button for primary actions */
        .btn-gradient {
            background: linear-gradient(to right, #00C853, #2196F3);
        }

        /* Main layout container */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        #app-content:not(.hidden) {
            display: flex !important;
        }

        /* Dashboard content area using Flexbox */
        .dashboard-content {
            flex: 1;
            display: flex;
            flex-direction: row;
            padding: 0.75rem; /* Reduced overall padding */
            gap: 0.75rem; /* Reduced gap between main sections */
            overflow-y: auto;
        }

        /* Left sidebar */
        .sidebar {
            width: 60px; /* Slightly reduced width */
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        /* Main dashboard panels container - now a 2x2 grid for large screens */
        .main-panels {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto;
            gap: 0.75rem; /* Reduced gap between panels */
            transition: grid-template-columns 0.3s ease-in-out, grid-template-rows 0.3s ease-in-out, gap 0.3s ease-in-out;
        }

        @media (min-width: 1024px) {
            .main-panels {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr 1fr;
            }
        }

        /* Right market list panel */
        .market-list-column {
            width: 260px; /* Slightly reduced width */
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        /* Sliding Portfolio Link Tab */
        .portfolio-tab {
            position: absolute; /* Keep absolute for sliding */
            top: 0;
            left: 60px; /* Adjusted position for smaller sidebar */
            width: 220px; /* Reduced width of the sliding tab */
            height: 100%; /* Take full height of sidebar */
            background-color: #3A3A3A; /* Slightly lighter background for the tab */
            transform: translateX(-100%); /* Initially hidden to the left */
            transition: transform 0.3s ease-out; /* Smooth slide transition */
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            z-index: 9; /* Below the main sidebar */
            display: flex; /* Always flex on desktop for sliding */
            flex-direction: column;
            padding: 0.75rem; /* Reduced padding */
            border-top-right-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            border-left: 1px solid #4A4A4A;
        }

        .sidebar:hover .portfolio-tab {
            transform: translateX(0); /* Slides in on hover */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 1023px) {
            .dashboard-content {
                flex-direction: column;
                padding: 0.75rem;
            }
            .sidebar {
                width: 100%;
                padding: 0.75rem;
                flex-direction: row; /* Icons in a row */
                justify-content: space-around; /* Distribute icons */
                height: auto;
            }
            .sidebar nav {
                display: flex; /* Ensure nav is flex for row layout */
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.75rem;
            }
            .sidebar a {
                padding: 0.5rem; /* Reduced padding for mobile sidebar links */
            }
            .sidebar span {
                display: none !important; /* Hide text labels on mobile sidebar */
            }
            .main-panels, .market-list-column {
                width: 100%;
            }
            .portfolio-tab {
                position: static; /* Remove absolute positioning on mobile */
                width: 100%;
                height: auto;
                transform: translateX(0); /* Always visible on mobile if desired */
                box-shadow: none;
                border-radius: 0;
                border: none;
                margin-top: 0.75rem; /* Reduced margin */
                display: flex; /* Ensure it's displayed */
            }
        }

        /* Styles for autocomplete suggestions */
        .autocomplete-suggestions {
            max-height: 180px; /* Reduced max height */
        }
        .autocomplete-suggestions li {
            padding: 0.6rem 0.8rem; /* Reduced padding */
            font-size: 0.9rem; /* Slightly reduced font size */
        }

        /* Ensure input and select elements have proper text color and background */
        input[type="text"],
        input[type="number"] {
            color: #E0E0E0;
            background-color: #1A1A1A;
            border: 1px solid #3A3A3A;
        }
        input::placeholder {
            color: #888888;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-position: right 0.6rem center; /* Adjusted position */
            background-size: 1.1rem; /* Slightly reduced size */
            padding-right: 2rem; /* Adjusted space for arrow */
            color: #E0E0E0 !important;
            background-color: #1A1A1A !important;
            border: 1px solid #3A3A3A;
        }
        select option {
            background-color: #1A1A1A !important;
            color: #E0E0E0 !important;
        }
        select option:checked {
            background-color: #2D2D2D !important;
            color: #FFFFFF !important;
        }

        /* Styles for content sections */
        .content-section {
            display: none;
            flex-direction: column;
            flex: 1;
            gap: 0.75rem; /* Reduced gap */
        }
        .content-section.active {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }
        .content-section.active.full-width {
            grid-template-columns: 1fr;
            grid-template-rows: auto;
        }

        /* Authentication Container Styles */
        #auth-container {
            padding: 1.5rem; /* Reduced padding */
        }
        .auth-form {
            padding: 1.5rem; /* Reduced padding */
            max-width: 360px; /* Slightly reduced max width */
        }
        .auth-form h2 {
            font-size: 2rem; /* Slightly reduced font size */
            margin-bottom: 1rem; /* Reduced margin */
        }
        .auth-form label {
            margin-bottom: 0.4rem; /* Reduced margin */
            font-size: 0.85rem; /* Slightly reduced font size */
        }
        .auth-form input[type="email"],
        .auth-form input[type="password"] {
            padding: 0.6rem 0.9rem; /* Reduced padding */
            margin-bottom: 0.8rem; /* Reduced margin */
            font-size: 0.95rem; /* Slightly reduced font size */
        }
        .auth-form button {
            padding: 0.6rem 1rem; /* Reduced padding */
            margin-top: 0.8rem; /* Reduced margin */
            font-size: 0.95rem; /* Slightly reduced font size */
        }
        .auth-message {
            margin-top: 0.8rem; /* Reduced margin */
            font-size: 0.85rem; /* Slightly reduced font size */
        }

        /* Live Chat Button */
        #live-chat-button {
            bottom: 15px; /* Reduced position */
            right: 15px; /* Reduced position */
            width: 50px; /* Reduced size */
            height: 50px; /* Reduced size */
            font-size: 20px; /* Reduced font size */
        }

        /* Chat Window */
        #chat-window {
            bottom: 75px; /* Adjusted position for smaller button */
            right: 15px; /* Adjusted position */
            width: 320px; /* Reduced width */
            height: 380px; /* Reduced height */
            border-radius: 10px; /* Slightly reduced border radius */
        }
        .chat-header {
            padding: 8px 12px; /* Reduced padding */
            font-size: 0.95rem; /* Slightly reduced font size */
        }
        .chat-header button {
            font-size: 18px; /* Slightly reduced font size */
            padding: 0 4px; /* Reduced padding */
        }
        .chat-messages {
            padding: 12px; /* Reduced padding */
            gap: 8px; /* Reduced gap */
        }
        .chat-message {
            padding: 6px 10px; /* Reduced padding */
            border-radius: 8px; /* Reduced border radius */
            font-size: 0.85rem; /* Slightly reduced font size */
        }
        .chat-input-area {
            padding: 8px 12px; /* Reduced padding */
        }
        .chat-input-area input {
            border-radius: 6px; /* Reduced border radius */
            padding: 6px 10px; /* Reduced padding */
            margin-right: 8px; /* Reduced margin */
            font-size: 0.85rem; /* Slightly reduced font size */
        }
        .chat-input-area button {
            padding: 6px 12px; /* Reduced padding */
            border-radius: 6px; /* Reduced border radius */
            font-size: 0.85rem; /* Slightly reduced font size */
        }
        .chat-loading-indicator {
            padding: 6px 10px; /* Reduced padding */
            border-radius: 8px; /* Reduced border radius */
            font-size: 0.85rem; /* Slightly reduced font size */
        }

        /* Styles for the maximize button */
        .maximize-btn {
            position: absolute;
            bottom: 8px; /* Adjusted position from bottom */
            right: 8px; /* Adjusted position from right */
            background: none;
            border: none;
            color: #FFFFFF !important; /* Set to pure white and important for maximum visibility */
            font-size: 20px; /* Slightly reduced font size */
            cursor: pointer;
            transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            z-index: 10;
        }
        /* Crucial: Ensure the SVG path inside the button is also white */
        .maximize-btn svg path {
            fill: #FFFFFF !important; /* Force fill to white */
            stroke: #FFFFFF !important; /* Force stroke to white if it exists */
        }
        .maximize-btn:hover {
            transform: scale(1.1);
            color: #00f2fe !important; /* Cyan hover effect and important */
        }
        /* Ensure hover effect also applies to the SVG path */
        .maximize-btn:hover svg path {
            fill: #00f2fe !important;
            stroke: #00f2fe !important;
        }


        /* Ensure panels are relative for absolute positioning */
        .dashboard-panel {
            position: relative;
            padding: 0.8rem; /* Reduced panel padding */
        }

        /* Maximize functionality refinement */
        .app-container.panel-maximized-active .dashboard-content {
            flex-grow: 1;
            height: 100%;
            overflow: hidden;
            padding: 0;
            gap: 0;
        }

        .dashboard-section.maximized-active {
            flex-grow: 1;
            height: 100%;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr !important;
            grid-template-rows: 1fr !important;
            gap: 0 !important;
        }

        .dashboard-panel.is-maximized {
            grid-column: 1 / -1 !important;
            grid-row: 1 / -1 !important;
            z-index: 100;
            overflow-y: auto;
            border-color: #00f2fe !important;
            border-radius: 0 !important;
            padding: 1.2rem !important; /* Adjusted padding for maximized view */
            display: flex;
            flex-direction: column;
        }

        /* Hide other panels when one is maximized */
        .dashboard-section.maximized-active > .dashboard-panel:not(.is-maximized) {
            display: none !important;
        }

        /* Adjust internal elements of maximized panels to fill space */
        .dashboard-panel.is-maximized > div:not(.maximize-btn) {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Adjust chart component's internal layout when maximized */
        #chart-panel.is-maximized #root,
        #chart-panel.is-maximized #root > div {
            height: 100%;
            flex-grow: 1;
        }

        #chart-panel.is-maximized .chart-container-wrapper {
            flex-grow: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #chart-panel.is-maximized .chart-container {
            flex-grow: 1;
            height: 100%;
        }

        #chart-panel.is-maximized .custom-scrollbar {
            max-height: none;
            flex-grow: 1;
        }

        /* Specific styles for news list to force scrolling */
        #recentMarketNewsList {
            max-height: 200px; /* Further reduced height to fit smaller UI */
            overflow-y: auto;
        }

        /* New styles from the provided chart code - adjusted for smaller UI */
        #chart-panel #root {
            height: calc(100% - 30px); /* Adjusted height to fit within the panel */
        }
        #chart-panel .container-gradient-border {
            padding: 1rem; /* Reduced padding */
            border-radius: 1rem; /* Slightly reduced border radius */
        }
        #chart-panel .container-gradient-border::before {
            border-radius: 1rem;
        }
        #chart-panel .chart-container {
            padding: 0.8rem; /* Reduced padding */
            border-radius: 0.8rem; /* Reduced border radius */
        }
        #chart-panel .primary-button {
            padding: 0.6rem 1.2rem; /* Reduced padding */
            border-radius: 0.6rem; /* Reduced border radius */
            font-size: 0.9rem; /* Reduced font size */
        }
        #chart-panel .range-button {
            padding: 0.4rem 0.8rem; /* Reduced padding */
            border-radius: 0.4rem; /* Reduced border radius */
            font-size: 0.8rem; /* Reduced font size */
        }
        #chart-panel input[type="text"] {
            padding: 0.6rem 0.9rem; /* Reduced padding */
            font-size: 0.9rem; /* Reduced font size */
        }
        #chart-panel .news-article {
            border-radius: 0.6rem; /* Reduced border radius */
            padding: 0.8rem; /* Reduced padding */
        }
        #chart-panel .news-article h4 {
            font-size: 0.9rem; /* Reduced font size */
        }
        #chart-panel .news-article p {
            font-size: 0.75rem; /* Reduced font size */
        }
        #chart-panel .news-article a {
            font-size: 0.75rem; /* Reduced font size */
        }
        #chart-panel .data-grid-item {
            padding-bottom: 0.4rem; /* Reduced padding */
            margin-bottom: 0.4rem; /* Reduced margin */
        }
        #chart-panel .data-grid-item span {
            font-size: 0.9rem; /* Reduced font size */
        }

        /* Styles for market cards */
        .market-card {
            background-color: #2D2D2D;
            border: 1px solid #3A3A3A;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .market-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .market-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #00f2fe; /* Cyan accent */
            margin-bottom: 0.5rem;
        }

        .market-card .price {
            font-size: 1.8rem;
            font-weight: 700;
            color: #E0E0E0;
            margin-bottom: 0.25rem;
        }

        .market-card .change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
        }

        .market-card .change.positive {
            color: #00C853; /* Green */
        }

        .market-card .change.negative {
            color: #D50000; /* Red */
        }

        .market-card .change svg {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Authentication Container (Initially Visible) -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-[#1A1A1A]">
        <div class="auth-form bg-[#252525] rounded-lg p-6 shadow-xl border border-[#3A3A3A] text-center">
            <h2 class="text-3xl font-bold text-white mb-4">APEX Investor Tool</h2>
            <p class="auth-message mb-4 text-gray-300" id="auth-status-message">Please log in or create an account.</p>
            <div class="mb-3 text-left">
                <label for="auth-email" class="block text-gray-400 text-sm mb-1">Email Address</label>
                <input type="email" id="auth-email" class="w-full p-2.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white" placeholder="your.email@example.com">
            </div>
            <div class="mb-4 text-left">
                <label for="auth-password" class="block text-gray-400 text-sm mb-1">Password</label>
                <input type="password" id="auth-password" class="w-full p-2.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white" placeholder="••••••••">
            </div>
            <button id="login-btn" class="btn-gradient w-full text-white font-bold py-2 rounded-md hover:opacity-90 transition-opacity duration-200 mb-3">Login</button>
            <button id="signup-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-md transition-colors duration-200">Sign Up</button>
        </div>
    </div>

    <!-- Main Application Content (Initially Hidden) -->
    <div id="app-content" class="app-container hidden">
        <!-- Top Navigation Bar -->
        <header class="bg-[#2A2A2A] p-2 flex items-center justify-between shadow-md flex-shrink-0 h-14"> <!-- Reduced padding and height -->
            <div class="flex items-center space-x-3"> <!-- Reduced space-x -->
                <!-- Logo/Platform Name -->
                <div class="flex items-center">
                    <img src="https://placehold.co/25x25/333/FFF?text=APEX" alt="APEX Logo" class="mr-1.5 rounded"> <!-- Reduced size and margin -->
                    <span class="text-base font-bold text-white hidden sm:block">APEX INVESTOR TOOL</span> <!-- Reduced font size -->
                </div>
                <!-- Asset Tabs (Simplified for this version, can be expanded) -->
                <nav class="hidden md:flex space-x-1.5 text-xs"> <!-- Reduced space-x and font size -->
                    <a href="#" class="nav-link text-white font-semibold py-1 px-2.5 rounded-md bg-blue-600" data-target="dashboard">Dashboard</a> <!-- Reduced padding -->
                    <a href="#" class="nav-link text-gray-400 hover:text-white py-1 px-2.5 rounded-md hover:bg-gray-700" data-target="portfolio">Portfolio</a>
                    <a href="#" class="nav-link text-gray-400 hover:text-white py-1 px-2.5 rounded-md hover:bg-gray-700" data-target="markets">Markets</a>
                    <a href="#" class="nav-link text-gray-400 hover:text-white py-1 px-2.5 rounded-md hover:bg-gray-700" data-target="research">Research</a>
                </nav>
            </div>
            <!-- Balance and Notifications -->
            <div class="flex items-center space-x-3"> <!-- Reduced space-x -->
                <div class="text-right">
                    <p class="text-xs text-gray-400">Total Portfolio Value</p>
                    <p class="font-semibold text-base accent-green" id="total-portfolio-value">---</p> <!-- Reduced font size -->
                </div>
                <!-- Logout Button in Header -->
                <button id="logout-btn" class="text-gray-400 hover:text-white p-1.5 rounded-md hover:bg-gray-700 transition-colors duration-200"> <!-- Reduced padding -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                </button>
            </div>
        </header>

        <!-- Main Content Area: Sidebar + Dashboard Panels -->
        <div class="dashboard-content">
            <!-- Left Sidebar (Icon-based, simplified for core functions) -->
            <aside class="sidebar panel-bg p-1.5 flex flex-col items-center shadow-md border-r border-color"> <!-- Reduced padding -->
                <nav class="space-y-3 py-3"> <!-- Reduced space-y and py -->
                    <a href="#" class="nav-link-sidebar block text-white p-1.5 rounded-lg bg-blue-600 transition-colors duration-200 group relative" data-target="dashboard"> <!-- Reduced padding -->
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        <span class="absolute left-full ml-1.5 px-1.5 py-0.5 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap hidden md:block">Dashboard</span>
                    </a>
                    <a href="#" class="nav-link-sidebar block text-gray-400 hover:text-white p-1.5 rounded-lg hover:bg-gray-700 transition-colors duration-200 group relative" data-target="portfolio">
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6a2 2 0 00-2-2H5a2 2 0 00-2 2v13a2 2 0 002 2h4a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <span class="absolute left-full ml-1.5 px-1.5 py-0.5 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap hidden md:block">Portfolio</span>
                    </a>
                    <a href="#" class="nav-link-sidebar block text-gray-400 hover:text-white p-1.5 rounded-lg hover:bg-gray-700 transition-colors duration-200 group relative" data-target="profile">
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        <span class="absolute left-full ml-1.5 px-1.5 py-0.5 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap hidden md:block">My Profile</span>
                    </a>
                    <a href="#" class="nav-link-sidebar block text-gray-400 hover:text-white p-1.5 rounded-lg hover:bg-gray-700 transition-colors duration-200 group relative" data-target="orders">
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span class="absolute left-full ml-1.5 px-1.5 py-0.5 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap hidden md:block">Orders</span>
                    </a>
                    <a href="#" class="nav-link-sidebar block text-gray-400 hover:text-white p-1.5 rounded-lg hover:bg-gray-700 transition-colors duration-200 group relative" data-target="statistics">
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                        <span class="absolute left-full ml-1.5 px-1.5 py-0.5 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap hidden md:block">Statistics</span>
                    </a>
                    <a href="#" class="nav-link-sidebar block text-gray-400 hover:text-white p-1.5 rounded-lg hover:bg-gray-700 transition-colors duration-200 group relative" data-target="history">
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="absolute left-full ml-1.5 px-1.5 py-0.5 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap hidden md:block">History</span>
                    </a>
                    <a href="#" class="nav-link-sidebar block text-gray-400 hover:text-white p-1.5 rounded-lg hover:bg-gray-700 transition-colors duration-200 group relative" data-target="deposit">
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <span class="absolute left-full ml-1.5 px-1.5 py-0.5 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap hidden md:block">Deposit</span>
                    </a>
                    <a href="#" class="nav-link-sidebar block text-gray-400 hover:text-white p-1.5 rounded-lg hover:bg-gray-700 transition-colors duration-200 group relative" data-target="support">
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 0A9.001 9.001 0 0112 21c-2.485 0-4.786-.993-6.432-2.684m0 0L5.636 18.364m12.728-12.728A9.001 9.001 0 0012 3c-2.485 0-4.786.993-6.432 2.684m0 0L5.636 5.636m12.728 0A9.001 9.001 0 0121 12c0 2.485-.993 4.786-2.684 6.432m0 0L18.364 18.364M3.512 9H9m-5.488 9H9m4.488-9H15m-1.488 9H15m4.488-9H21m-5.488 9H21M3 12h6m-6 6h6m8-6h6m-6 6h6"></path></svg>
                        <span class="absolute left-full ml-1.5 px-1.5 py-0.5 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap hidden md:block">Support</span>
                    </a>
                </nav>

                <!-- Sliding Portfolio Link Tab -->
                <div class="portfolio-tab md:flex"> <!-- Removed 'hidden' class here -->
                    <h3 class="text-base font-semibold text-white mb-2">Link Your Portfolio</h3> <!-- Reduced font size and margin -->
                    <p class="text-xs text-gray-300 mb-3">Connect your existing broker accounts to view and manage your portfolio directly within APEX Tool.</p> <!-- Reduced font size and margin -->
                    <button class="w-full btn-gradient text-white font-bold py-1.5 rounded-lg text-xs"
        onclick="connectBroker()">
  Connect Broker
</button>
 <!-- Reduced padding and font size -->
                    <div class="mt-auto pt-2 border-t border-gray-600 text-center"> <!-- Reduced padding-top -->
                        <p class="text-xs text-gray-400">Secure & Encrypted Connection</p>
                    </div>
                </div>
            </aside>

            <!-- Main Dashboard Content Area -->
            <div class="flex-1 flex flex-col gap-3"> <!-- Reduced gap -->
                <!-- Dashboard Section -->
                <main id="dashboard-section" class="content-section active">
                    <!-- Top-Left: Main Chart Panel (Now the new React Chart) -->
                    <div id="chart-panel" class="panel-bg rounded-lg p-3 shadow-lg flex flex-col flex-1 border border-color dashboard-panel"> <!-- Reduced padding -->
                        <div class="flex justify-between items-center mb-1.5"> <!-- Reduced margin -->
                            <h2 id="chartTitle" class="text-base font-semibold text-white">Market Analysis</h2> <!-- Reduced font size -->
                        </div>
                        <!-- React Chart Application will render here -->
                        <div id="root" class="min-h-full flex flex-col items-center justify-center p-0 sm:p-0">
                            <div id="loading-message" class="text-red-400 text-center text-lg mt-8">Initializing Chart...</div> <!-- Reduced font size and margin -->
                        </div>
                        <button class="maximize-btn" data-panel-id="chart-panel">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-icon-type="plus"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.5v15m7.5-7.5h-15"></path></svg>
                        </button>

                        <script>
                            // Self-executing function to ensure DOM is fully loaded and React/Chart.js are available
                            (function() {
                                // Small delay to ensure all external scripts (Tailwind, React, Chart.js) are parsed
                                // This helps with "not responding" errors, especially on slower connections or local file runs
                                setTimeout(() => {
                                    try {
                                        // Check if React and ReactDOM are available before attempting to render
                                        if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                                            document.getElementById('root').innerHTML = '<div style="color:red;text-align:center; font-family: \'Roboto Mono\', monospace;">Error: React or ReactDOM not loaded. Check script tags and network.</div>';
                                            console.error("React or ReactDOM is not defined. Ensure libraries are loaded correctly.");
                                            return;
                                        }

                                        // Check if Chart.js is available
                                        if (typeof Chart === 'undefined') {
                                            document.getElementById('root').innerHTML = '<div style="color:red;text-align:center; font-family: \'Roboto Mono\', monospace;">Error: Chart.js not loaded. Check script tags and network.</div>';
                                            console.error("Chart.js is not defined. Ensure library is loaded correctly.");
                                            return;
                                        }

                                        // Register Chart.js components
                                        Chart.register(
                                            Chart.LineController,
                                            Chart.LineElement,
                                            Chart.PointElement,
                                            Chart.LinearScale,
                                            Chart.CategoryScale,
                                            Chart.Tooltip,
                                            Chart.Legend
                                        );

                                        const StockGraphViewer = () => {
                                            const [symbol, setSymbol] = React.useState('');
                                            const [suggestions, setSuggestions] = React.useState([]);
                                            const [currentPrice, setCurrentPrice] = React.useState(null);
                                            const [percentageChange, setPercentageChange] = React.useState(null);
                                            const [quoteData, setQuoteData] = React.useState(null);
                                            const [loading, setLoading] = React.useState(false);
                                            const [error, setError] = React.useState('');
                                            const [range, setRange] = React.useState('5Y'); // Default range
                                            const [news, setNews] = React.useState([]);
                                            const [newsLoading, setNewsLoading] = React.useState(false);
                                            const [newsError, setNewsError] = React.useState('');
                                            const [dividendInfo, setDividendInfo] = React.useState(null);
                                            const chartRef = React.useRef(null);
                                            const chartInstanceRef = React.useRef(null);

                                            // ===================================================================
                                            // IMPORTANT: REPLACE WITH YOUR ACTUAL API KEYS
                                            // GET THEM FROM:
                                            // FMP: https://financialmodelingprep.com/developer/docs/dashboard
                                            // Google Gemini: https://aistudio.google.com/app/apikey (choose a new API key)
                                            // ===================================================================
                                            const FMP_API_KEY = "6uFHicw1PX5heQjTn6N2JlCRE73K1kV8"; // <--- YOUR FMP API KEY HERE
                                            const GEMINI_API_KEY = ""; // <--- YOUR GOOGLE GEMINI API KEY HERE (leave empty for Canvas runtime)
                                            // ===================================================================


                                            const rangeMap = {
                                                '1D': 1,
                                                '5D': 5,
                                                '1M': 30,
                                                '6M': 180,
                                                'YTD': 'YTD',
                                                '1Y': 365,
                                                '2Y': 730,
                                                '5Y': 1825,
                                                'ALL': 'MAX' // 'MAX' for all available data from FMP
                                            };

                                            const getFromDate = (range) => {
                                                const now = new Date();
                                                if (range === 'YTD') {
                                                    return new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
                                                } else if (range === 'MAX') {
                                                    // FMP often requires a very early specific date for 'MAX' history
                                                    // A very old date like this typically fetches the full available history.
                                                    return '1900-01-01';
                                                }
                                                else {
                                                    const days = rangeMap[range];
                                                    const past = new Date();
                                                    past.setDate(past.getDate() - days);
                                                    return past.toISOString().split('T')[0];
                                                }
                                            };

                                            React.useEffect(() => {
                                                const delayDebounce = setTimeout(async () => {
                                                    if (symbol.trim().length > 0) {
                                                        try {
                                                            const res = await fetch(`https://financialmodelingprep.com/api/v3/search?query=${symbol.trim()}&limit=10&apikey=${FMP_API_KEY}`);
                                                            if (!res.ok) { // Check for HTTP errors
                                                                throw new Error(`FMP Search API HTTP error: ${res.status}`);
                                                            }
                                                            const data = await res.json();
                                                            setSuggestions(data || []);
                                                        } catch (err) {
                                                            console.error("Error fetching suggestions from FMP:", err);
                                                            setSuggestions([]);
                                                        }
                                                    } else {
                                                        setSuggestions([]);
                                                    }
                                                }, 300);
                                                return () => clearTimeout(delayDebounce);
                                            }, [symbol]);

                                            const fetchNews = async (stockSymbol) => {
                                                setNewsLoading(true);
                                                setNewsError('');
                                                setNews([]);
                                                try {
                                                    const newsApiUrl = `https://financialmodelingprep.com/api/v3/stock_news?tickers=${stockSymbol.toUpperCase()}&limit=10&apikey=${FMP_API_KEY}`;
                                                    const response = await fetch(newsApiUrl);
                                                    if (!response.ok) { // Check for HTTP errors
                                                        throw new Error(`FMP News API HTTP error: ${response.status}`);
                                                    }
                                                    const data = await response.json();

                                                    if (Array.isArray(data) && data.length > 0) {
                                                        const formattedNews = data.map(article => ({
                                                            title: article.title,
                                                            snippet: article.text,
                                                            url: article.url
                                                        })).filter(item => item.title && item.url && item.url.startsWith('http'));

                                                        setNews(formattedNews);
                                                    } else {
                                                        setNewsError('No news articles found for this stock from FMP API.');
                                                    }
                                                } catch (err) {
                                                    setNewsError(`Error fetching news: ${err.message}. Please check your FMP API key and console.`);
                                                    console.error("Error fetching news from FMP API:", err);
                                                } finally {
                                                    setNewsLoading(false);
                                                }
                                            };

                                            const fetchDividendInfo = async (stockSymbol) => {
                                                setDividendInfo(null);
                                                try {
                                                    const prompt = `Provide the current dividend yield and the last quarterly dividend per share for ${stockSymbol} stock. If the stock does not pay dividends, indicate that. Return the data as a JSON object with 'dividendYield' (as a decimal, e.g., 0.025 for 2.5%) and 'quarterlyDividend' (as a number, e.g., 0.51). If data is not available or the stock doesn't pay dividends, set the value to null.`;
                                                    const payload = {
                                                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                                                        generationConfig: {
                                                            responseMimeType: "application/json",
                                                            responseSchema: {
                                                                type: "OBJECT",
                                                                properties: {
                                                                    "dividendYield": { "type": "number", "nullable": true },
                                                                    "quarterlyDividend": { "type": "number", "nullable": true }
                                                                }
                                                            }
                                                        }
                                                    };
                                                    const apiKey = GEMINI_API_KEY; // Use the provided Gemini API key
                                                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                                                    const response = await fetch(apiUrl, {
                                                        method: 'POST',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify(payload)
                                                    });

                                                    if (!response.ok) { // Check for HTTP errors
                                                        const errorBody = await response.text();
                                                        throw new Error(`Gemini API HTTP error: ${response.status} - ${errorBody}`);
                                                    }

                                                    const result = await response.json();

                                                    // Deeper check for content parts
                                                    if (result.candidates && result.candidates.length > 0 &&
                                                        result.candidates[0].content && result.candidates[0].content.parts &&
                                                        result.candidates[0].content.parts.length > 0 &&
                                                        result.candidates[0].content.parts[0].text) {
                                                        const jsonText = result.candidates[0].content.parts[0].text;
                                                        try {
                                                            const parsedDividend = JSON.parse(jsonText);
                                                            setDividendInfo(parsedDividend);
                                                        } catch (parseError) {
                                                            console.warn("Failed to parse Gemini API JSON response:", jsonText, parseError);
                                                            setDividendInfo(null);
                                                        }
                                                    } else {
                                                        console.log("No valid content from Gemini API for:", stockSymbol, result);
                                                        setDividendInfo(null);
                                                    }
                                                } catch (err) {
                                                    console.error("Error fetching dividend info from Gemini API:", err);
                                                    // More specific error message for the user if it's an API key issue
                                                    if (err.message.includes('400') || err.message.includes('403') || err.message.includes('API key not valid')) {
                                                        console.error("Likely Gemini API Key Issue: Check your API key and ensure it's correctly set up for the Gemini API.");
                                                    }
                                                    setDividendInfo(null);
                                                }
                                            };

                                            const fetchStockData = async () => {
                                                if (!symbol.trim()) {
                                                    setError('Please enter a stock or crypto symbol.');
                                                    return;
                                                }
                                                setLoading(true);
                                                setError('');
                                                setCurrentPrice(null);
                                                setPercentageChange(null);
                                                setQuoteData(null);
                                                setNews([]);
                                                setDividendInfo(null);

                                                try {
                                                    const from = getFromDate(range);
                                                    const historicalUrl = `https://financialmodelingprep.com/api/v3/historical-price-full/${symbol.toUpperCase()}?from=${from}&apikey=${FMP_API_KEY}`;
                                                    const quoteUrl = `https://financialmodelingprep.com/api/v3/quote/${symbol.toUpperCase()}?apikey=${FMP_API_KEY}`;

                                                    const [historicalRes, quoteRes] = await Promise.all([
                                                        fetch(historicalUrl),
                                                        fetch(quoteUrl)
                                                    ]);

                                                    if (!historicalRes.ok || !quoteRes.ok) {
                                                        let errorMessage = 'Failed to fetch stock data.';
                                                        if (historicalRes.status === 401 || quoteRes.status === 401) {
                                                            errorMessage += ' (Unauthorized: Check your FMP API key.)';
                                                        } else if (historicalRes.status === 404 || quoteRes.status === 404) {
                                                            errorMessage += ' (Symbol not found or no data available.)';
                                                        }
                                                        throw new Error(errorMessage);
                                                    }

                                                    const historicalData = await historicalRes.json();
                                                    const quote = await quoteRes.json();

                                                    if (historicalData.historical && historicalData.historical.length > 0 && quote.length > 0) {
                                                        const sorted = historicalData.historical.sort((a, b) => new Date(a.date) - new Date(b.date));
                                                        const labels = sorted.map(d => d.date);
                                                        const prices = sorted.map(d => d.close);

                                                        const firstPrice = prices[0];
                                                        const lastPrice = prices[prices.length - 1];
                                                        const change = ((lastPrice - firstPrice) / firstPrice) * 100;

                                                        setCurrentPrice(quote[0].price);
                                                        setQuoteData(quote);
                                                        setPercentageChange(change);

                                                        if (chartInstanceRef.current) chartInstanceRef.current.destroy();
                                                        const ctx = chartRef.current.getContext('2d');
                                                        chartInstanceRef.current = new Chart(ctx, {
                                                            type: 'line',
                                                            data: {
                                                                labels,
                                                                datasets: [{
                                                                    label: `${symbol.toUpperCase()} Price`,
                                                                    data: prices,
                                                                    borderColor: '#00f2fe',
                                                                    backgroundColor: 'rgba(0, 242, 254, 0.1)',
                                                                    borderWidth: 2,
                                                                    pointRadius: 0,
                                                                    fill: true,
                                                                    tension: 0.4
                                                                }]
                                                            },
                                                            options: {
                                                                responsive: true,
                                                                maintainAspectRatio: false,
                                                                interaction: { mode: 'index', intersect: false },
                                                                plugins: {
                                                                    legend: { labels: { color: '#8892b0' } },
                                                                    tooltip: {
                                                                        enabled: true,
                                                                        mode: 'index',
                                                                        intersect: false,
                                                                        callbacks: {
                                                                            label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toFixed(2)}`
                                                                        },
                                                                        backgroundColor: 'rgba(26, 26, 46, 0.9)',
                                                                        borderColor: '#00f2fe',
                                                                        borderWidth: 1,
                                                                        titleColor: '#00f2fe',
                                                                        bodyColor: '#e0e7ff',
                                                                    }
                                                                },
                                                                scales: {
                                                                    x: {
                                                                        grid: { color: '#2a2a40', drawBorder: false },
                                                                        ticks: { color: '#8892b0', maxTicksLimit: 10 }
                                                                    },
                                                                    y: {
                                                                        grid: { color: '#2a2a40', drawBorder: false },
                                                                        ticks: {
                                                                            color: '#8892b0',
                                                                            callback: value => '$' + value.toFixed(2)
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        });
                                                        fetchNews(symbol.toUpperCase());
                                                        fetchDividendInfo(symbol.toUpperCase());
                                                    } else {
                                                        setError('No historical or current quote data found for this symbol. It might be invalid or no data exists for the selected range.');
                                                    }
                                                } catch (err) {
                                                    setError(`Error fetching stock data: ${err.message}`);
                                                    console.error("Detailed error during stock data fetch:", err);
                                                    if (err.message.includes('401') || err.message.includes('Unauthorized')) {
                                                        setError('FMP API Key may be invalid or expired. Please check your FMP API key.');
                                                    }
                                                } finally {
                                                    setLoading(false);
                                                }
                                            };

                                            React.useEffect(() => {
                                                // Only fetch data if a symbol is set and the range changes
                                                // This prevents an initial fetch on component mount if no symbol is pre-set
                                                if (symbol.trim()) {
                                                    fetchStockData();
                                                }
                                            }, [range]); // Dependency array: re-run when 'range' changes

                                            const formatValue = (value, isPercentage = false, isCurrency = false) => {
                                                if (value === null || value === undefined || isNaN(parseFloat(value))) {
                                                    return "—";
                                                }
                                                const numValue = parseFloat(value);
                                                if (isPercentage) {
                                                    return `${(numValue * 100).toFixed(2)}%`;
                                                }
                                                if (isCurrency) {
                                                    return `$${numValue.toFixed(2)}`;
                                                }
                                                return numValue.toFixed(2);
                                            };

                                            return React.createElement("div", { className: "w-full h-full container-gradient-border" },
                                                React.createElement("h2", { className: "text-xl font-bold text-center mb-3 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500" }, "Quantum Insight Terminal"), <!-- Reduced font size and margin -->
                                                React.createElement("div", { className: "relative mb-3" }, <!-- Reduced margin -->
                                                    React.createElement("input", {
                                                        type: "text",
                                                        className: "w-full p-2.5 rounded-lg placeholder-gray-500 focus:outline-none focus:ring-2", <!-- Reduced padding -->
                                                        placeholder: "Enter Ticker (e.g., AAPL, MSFT, BTCUSD)",
                                                        value: symbol,
                                                        onChange: e => setSymbol(e.target.value),
                                                        onKeyPress: e => {
                                                            if (e.key === 'Enter') {
                                                                fetchStockData();
                                                                setSuggestions([]);
                                                            }
                                                        }
                                                    }),
                                                    suggestions.length > 0 && React.createElement("ul", { className: "absolute z-50 bg-[#1a1a2e] border border-blue-700 rounded-lg mt-0.5 w-full max-h-36 overflow-y-auto shadow-lg" }, <!-- Reduced margin-top and max-height -->
                                                        suggestions.map(item => React.createElement("li", {
                                                            key: item.symbol,
                                                            className: "p-1.5 text-gray-200 hover:bg-blue-800 hover:text-white cursor-pointer transition-colors duration-200", <!-- Reduced padding -->
                                                            onClick: () => {
                                                                setSymbol(item.symbol);
                                                                setSuggestions([]);
                                                                fetchStockData();
                                                            }
                                                        }, React.createElement("span", { className: "font-semibold text-blue-300" }, item.symbol), ` — ${item.name}`))
                                                    )
                                                ),
                                                React.createElement("div", { className: "flex flex-wrap gap-1.5 mb-3 justify-center" }, <!-- Reduced gap and margin -->
                                                    ['1D', '5D', '1M', '6M', 'YTD', '1Y', '2Y', '5Y', 'ALL'].map(r =>
                                                        React.createElement("button", {
                                                            key: r,
                                                            className: `range-button ${range === r ? 'active' : ''}`,
                                                            onClick: () => setRange(r)
                                                        }, r)
                                                    )
                                                ),
                                                React.createElement("button", {
                                                    onClick: fetchStockData,
                                                    className: "primary-button w-full mb-3", <!-- Reduced margin -->
                                                    disabled: loading
                                                }, loading ? 'Processing Data...' : 'Access Market Data'),
                                                error && React.createElement("p", { className: "text-red-400 text-center mt-1.5 text-sm" }, error), <!-- Reduced margin and font size -->

                                                (currentPrice || percentageChange !== null) && React.createElement("div", { className: "flex justify-center items-baseline space-x-3 mb-3" }, <!-- Reduced space-x and margin -->
                                                    currentPrice && React.createElement("p", { className: "text-green-400 text-2xl font-bold" }, `$${currentPrice.toFixed(2)}`), <!-- Reduced font size -->
                                                    percentageChange !== null && React.createElement("p", {
                                                        className: `text-lg font-semibold ${percentageChange >= 0 ? 'text-green-400' : 'text-red-500'}` <!-- Reduced font size -->
                                                    }, `${percentageChange.toFixed(2)}%`)
                                                ),
                                                
                                                React.createElement("div", { className: "grid grid-cols-1 lg:grid-cols-3 gap-3 mt-3 h-full flex-grow" }, <!-- Reduced gap and margin -->
                                                    React.createElement("div", { className: "chart-container-wrapper col-span-1 lg:col-span-2 flex flex-col" },
                                                        React.createElement("div", { className: "chart-container" },
                                                            React.createElement("canvas", { ref: chartRef })
                                                        )
                                                    ),

                                                    React.createElement("div", { className: "mt-0 lg:mt-0 flex flex-col" },
                                                        React.createElement("h3", { className: "text-lg font-bold text-center mb-2 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-500" }, "Latest Intel Reports"), <!-- Reduced font size and margin -->
                                                        newsLoading && React.createElement("p", { className: "text-gray-400 text-center text-xs" }, "Accessing news feeds..."), <!-- Reduced font size -->
                                                        newsError && React.createElement("p", { className: "text-red-500 text-center text-xs" }, newsError), <!-- Reduced font size -->
                                                        news.length > 0 && React.createElement("div", { className: "space-y-2 max-h-[calc(100%-40px)] overflow-y-auto pr-1.5 custom-scrollbar" }, <!-- Reduced space-y and max-height -->
                                                            news.map((article, index) => article.title && React.createElement("div", { key: index, className: "news-article" },
                                                                React.createElement("h4", { className: "text-sm font-semibold text-blue-300 mb-0.5" }, article.title), <!-- Reduced font size and margin -->
                                                                article.snippet && React.createElement("p", { className: "text-xs text-gray-400 mb-1" }, article.snippet), <!-- Reduced font size and margin -->
                                                                article.url && React.createElement("a", { href: article.url, target: "_blank", rel: "noopener noreferrer", className: "text-cyan-400 hover:underline text-xs font-medium" }, "Read Full Report →") <!-- Reduced font size -->
                                                            ))
                                                        ),
                                                        news.length === 0 && !newsLoading && !newsError && React.createElement("p", { className: "text-gray-500 text-center text-xs" }, "No recent intel available for this asset.") <!-- Reduced font size -->
                                                    )
                                                ),

                                                quoteData && quoteData[0] && React.createElement("div", {
                                                    className: "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 mt-4 text-xs text-gray-300 bg-[#1a1a2e] p-4 rounded-lg border border-blue-700 shadow-lg" <!-- Reduced gaps, margin, padding, font size, border radius -->
                                                }, [
                                                    ["Open", quoteData[0].open],
                                                    ["Day High", quoteData[0].dayHigh],
                                                    ["Day Low", quoteData[0].dayLow],
                                                    ["Market Cap", quoteData[0].marketCap ? `$${(quoteData[0].marketCap / 1e9).toFixed(2)}B` : "—"],
                                                    ["P/E Ratio", formatValue(quoteData[0].pe)],
                                                    ["Dividend Yield", dividendInfo && typeof dividendInfo.dividendYield === 'number' ? formatValue(dividendInfo.dividendYield, true) : "—"],
                                                    ["52W High", quoteData[0].yearHigh],
                                                    ["52W Low", quoteData[0].yearLow],
                                                    ["Quarterly Div", dividendInfo && typeof dividendInfo.dividendYield === 'number' ? formatValue(dividendInfo.quarterlyDividend, false, true) : "—"]
                                                ].map(([label, value]) =>
                                                    React.createElement("div", { key: label, className: "data-grid-item flex justify-between items-center" },
                                                        React.createElement("span", { className: "text-blue-300 font-light" }, label),
                                                        React.createElement("span", { className: "font-mono text-white text-sm" }, value !== undefined ? value : "—") <!-- Reduced font size -->
                                                    )
                                                ))
                                            );
                                        };

                                        const App = () => {
                                            return React.createElement("div", { className: "w-full h-full text-gray-100" },
                                                React.createElement(StockGraphViewer, null)
                                            );
                                        };

                                        // Remove loading message and render the app
                                        const loadingMessageElement = document.getElementById('loading-message');
                                        if (loadingMessageElement) {
                                            loadingMessageElement.remove();
                                        }
                                        ReactDOM.render(React.createElement(App, null), document.getElementById('root'));

                                    } catch (e) {
                                        console.error("Critical rendering error:", e);
                                        const rootElement = document.getElementById('root');
                                        if (rootElement) {
                                            rootElement.innerHTML = '<div style="color:red;text-align:center; padding: 15px; font-size: 1rem; font-family: \'Roboto Mono\', monospace;">Application failed to load.<br/>Please check the console (F12) for errors.<br/>Common issues: Invalid API keys, network problems, or script loading failures.</div>'; <!-- Reduced padding and font size -->
                                        }
                                    }
                                }, 50); // Small delay to ensure external scripts are fully loaded
                            })(); // Immediately Invoked Function Expression
                        </script>
                    </div>

                    <!-- Top-Right: Portfolio Summary Panel -->
                    <div id="portfolio-summary-panel" class="panel-bg rounded-lg p-3 shadow-lg flex flex-col flex-1 border border-color dashboard-panel"> <!-- Reduced padding -->
                        <div class="flex justify-between items-center mb-1.5"> <!-- Reduced margin -->
                            <h2 class="text-base font-semibold text-white mb-0.5">My Portfolio Overview</h2> <!-- Reduced font size and margin -->
                        </div>
                        <div class="flex-1 overflow-y-auto text-sm"> <!-- Reduced font size -->
                            <ul class="space-y-1.5"> <!-- Reduced space-y -->
                                <li class="flex justify-between items-center py-0.5 border-b border-gray-700 last:border-b-0"> <!-- Reduced padding -->
                                    <span class="text-white font-semibold">Total Invested:</span>
                                    <span class="font-semibold text-white" id="dashboard-total-invested">---</span>
                                </li>
                                <li class="flex justify-between items-center py-0.5 border-b border-gray-700 last:border-b-0">
                                    <span class="text-white font-semibold">Current Value:</span>
                                    <span class="font-semibold text-white" id="dashboard-current-value">---</span>
                                </li>
                                <li class="flex justify-between items-center py-0.5 border-b border-gray-700 last:border-b-0">
                                    <span class="text-white font-semibold">Overall Gain/Loss (%):</span>
                                    <span class="font-semibold text-white" id="dashboard-overall-gain-loss-percent">---</span>
                                </li>
                                <li class="flex justify-between items-center py-0.5 border-b border-gray-700 last:border-b-0">
                                    <span class="text-white font-semibold">Linked Broker:</span>
                                    <span class="text-white">---</span>
                                </li>
                                <li class="flex justify-between items-center py-0.5">
                                    <button class="text-xs accent-blue hover:underline" onclick="showCustomMessage('Redirecting to Portfolio Management...');">Manage Portfolios</button> <!-- Reduced font size -->
                                    <button class="text-xs accent-blue hover:underline" id="build-portfolio-btn">Build New Portfolio</button> <!-- Reduced font size -->
                                </li>
                            </ul>
                        </div>
                        <button class="maximize-btn" data-panel-id="portfolio-summary-panel">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-icon-type="plus"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.5v15m7.5-7.5h-15"></path></svg>
                        </button>
                    </div>

                    <!-- Bottom-Left: Trade Execution / Order Routing Panel -->
                    <div id="trade-panel" class="panel-bg rounded-lg p-3 shadow-lg flex flex-col flex-1 border border-color dashboard-panel"> <!-- Reduced padding -->
                        <div class="flex justify-between items-center mb-1.5"> <!-- Reduced margin -->
                            <h2 class="text-base font-semibold text-white mb-0.5">Place Trade (via Broker)</h2> <!-- Reduced font size and margin -->
                        </div>
                        <div class="mb-2.5 relative"> <!-- Reduced margin -->
                            <label for="tradeSymbol" class="block text-gray-400 text-xs mb-0.5">Symbol</label> <!-- Reduced font size and margin -->
                            <input type="text" id="tradeSymbol" value="" class="w-full px-2.5 py-1.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white text-sm" placeholder="e.g., AAPL, MSFT"> <!-- Reduced padding and font size -->
                            <!-- Autocomplete Suggestions will be inserted here -->
                            <ul id="symbolSuggestions" class="autocomplete-suggestions hidden"></ul>
                        </div>
                        <div class="mb-2.5"> <!-- Reduced margin -->
                            <label for="tradeType" class="block text-gray-400 text-xs mb-0.5">Type</label>
                            <select id="tradeType" class="w-full px-2.5 py-1.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white text-sm"> <!-- Reduced padding and font size -->
                                <option>Buy</option>
                                <option>Sell</option>
                            </select>
                        </div>
                        <div class="mb-2.5"> <!-- Reduced margin -->
                            <label for="tradeQuantity" class="block text-gray-400 text-xs mb-0.5">Quantity</label>
                            <input type="number" id="tradeQuantity" value="10" class="w-full px-2.5 py-1.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white text-sm"> <!-- Reduced padding and font size -->
                        </div>
                        <div class="mb-3"> <!-- Reduced margin -->
                            <label for="targetBroker" class="block text-gray-400 text-xs mb-0.5">Send to Broker</label>
                            <select id="targetBroker" class="w-full px-2.5 py-1.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white text-sm"> <!-- Reduced padding and font size -->
                                <option>Fidelity Investments</option>
                                <option>Charles Schwab</option>
                                <option>TD Ameritrade</option>
                                <option>E*TRADE</option>
                                <option>Vanguard</option>
                                <option>Interactive Brokers</option>
                                <option>Robinhood</option>
                                <option>Webull</option>
                                <option>Merrill Edge</option>
                                <option>Ally Invest</option>
                            </select>
                        </div>
                        <button class="w-full btn-gradient text-white font-bold py-1.5 rounded-lg text-sm hover:opacity-90 transition-opacity duration-200" onclick="sendOrderToBroker()">Send Order to Broker</button> <!-- Reduced padding and font size -->
                        <button class="maximize-btn" data-panel-id="trade-panel">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-icon-type="plus"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.5v15m7.5-7.5h-15"></path></svg>
                        </button>
                    </div>

                    <!-- Bottom-Right: Recent Market News Panel -->
                    <div id="news-panel" class="panel-bg rounded-lg p-3 shadow-lg flex flex-col flex-1 border border-color dashboard-panel"> <!-- Reduced padding -->
                        <div class="flex justify-between items-center mb-1.5"> <!-- Reduced margin -->
                            <h2 class="text-base font-semibold text-white mb-0.5">Recent Market News</h2> <!-- Reduced font size and margin -->
                        </div>
                        <div class="overflow-y-auto flex-1 text-sm" id="recentMarketNewsList"> <!-- Reduced font size -->
                            <!-- News will be populated here by JavaScript -->
                            <ul class="space-y-1.5"> <!-- Reduced space-y -->
                                <li><p class="text-gray-400 text-center py-1">Loading market news...</p></li> <!-- Reduced padding -->
                            </ul>
                        </div>
                        <button class="maximize-btn" data-panel-id="news-panel">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-icon-type="plus"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.5v15m7.5-7.5h-15"></path></svg>
                        </button>
                    </div>
                </main>

                <!-- NEW: Portfolio Section -->
                <section id="portfolio-section" class="content-section full-width panel-bg rounded-lg p-3 shadow-lg border border-color">
                    <h2 class="text-base font-semibold text-white mb-2.5">My Portfolio</h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <div class="flex-1">
                            <h3 class="text-sm font-semibold text-white mb-1.5">Add New Asset</h3>
                            <div class="space-y-2">
                                <div>
                                    <label for="portfolioNameInput" class="block text-gray-400 text-xs mb-0.5">Portfolio Name</label>
                                    <input type="text" id="portfolioNameInput" class="w-full px-2.5 py-1.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white text-sm" placeholder="e.g., My Growth Portfolio">
                                </div>
                                <div>
                                    <label for="portfolioSymbol" class="block text-gray-400 text-xs mb-0.5">Symbol</label>
                                    <input type="text" id="portfolioSymbol" class="w-full px-2.5 py-1.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white text-sm" placeholder="e.g., AAPL, BTCUSD">
                                    <ul id="portfolioSymbolSuggestions" class="autocomplete-suggestions hidden absolute z-50 bg-[#1a1a2e] border border-blue-700 rounded-lg mt-0.5 w-[calc(100%-1.5rem)] max-h-36 overflow-y-auto shadow-lg"></ul>
                                </div>
                                <div>
                                    <label for="portfolioQuantity" class="block text-gray-400 text-xs mb-0.5">Quantity</label>
                                    <input type="number" id="portfolioQuantity" value="1" min="1" class="w-full px-2.5 py-1.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white text-sm">
                                </div>
                                <div>
                                    <label for="portfolioPurchasePrice" class="block text-gray-400 text-xs mb-0.5">Purchase Price (per unit)</label>
                                    <input type="number" id="portfolioPurchasePrice" value="0.00" min="0" step="0.01" class="w-full px-2.5 py-1.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white text-sm">
                                </div>
                                <button id="addAssetBtn" class="w-full btn-gradient text-white font-bold py-1.5 rounded-lg text-sm hover:opacity-90 transition-opacity duration-200">Add Asset to Portfolio</button>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-sm font-semibold text-white mb-1.5">Portfolio Summary (<span id="currentPortfolioName">Default</span>)</h3>
                            <ul class="space-y-1.5 text-sm">
                                <li class="flex justify-between items-center py-0.5 border-b border-gray-700 last:border-b-0">
                                    <span class="text-white font-semibold">Total Invested:</span>
                                    <span class="font-semibold text-white" id="portfolioSummaryInvested">$0.00</span>
                                </li>
                                <li class="flex justify-between items-center py-0.5 border-b border-gray-700 last:border-b-0">
                                    <span class="text-white font-semibold">Current Total Value:</span>
                                    <span class="font-semibold text-white" id="portfolioSummaryCurrentValue">$0.00</span>
                                </li>
                                <li class="flex justify-between items-center py-0.5 border-b border-gray-700 last:border-b-0">
                                    <span class="text-white font-semibold">Overall Gain/Loss:</span>
                                    <span class="font-semibold" id="portfolioSummaryGainLoss">$0.00 (0.00%)</span>
                                </li>
                                <li class="flex justify-between items-center py-0.5 border-b border-gray-700 last:border-b-0">
                                    <span class="text-white font-semibold">Number of Assets:</span>
                                    <span class="font-semibold text-white" id="portfolioAssetCount">0</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <h3 class="text-sm font-semibold text-white mb-1.5">My Holdings</h3>
                    <div id="portfolio-loading-indicator" class="text-gray-400 text-center text-xs mb-1.5 hidden">Updating prices...</div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs text-gray-300">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="py-1.5 px-2.5 text-left">Symbol</th>
                                    <th class="py-1.5 px-2.5 text-left">Quantity</th>
                                    <th class="py-1.5 px-2.5 text-left">Avg. Purchase Price</th>
                                    <th class="py-1.5 px-2.5 text-left">Current Price</th>
                                    <th class="py-1.5 px-2.5 text-left">Total Invested</th>
                                    <th class="py-1.5 px-2.5 text-left">Current Value</th>
                                    <th class="py-1.5 px-2.5 text-left">Gain/Loss ($)</th>
                                    <th class="py-1.5 px-2.5 text-left">Gain/Loss (%)</th>
                                    <th class="py-1.5 px-2.5 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="portfolioHoldingsTableBody">
                                <!-- Portfolio items will be dynamically inserted here -->
                                <tr><td colspan="9" class="text-center py-2 text-gray-400">No assets in your portfolio yet. Add some above!</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- NEW: Markets Section -->
                <section id="markets-section" class="content-section full-width panel-bg rounded-lg p-3 shadow-lg border border-color">
                    <h2 class="text-base font-semibold text-white mb-2.5">Dominant Markets Overview</h2>
                    <div id="dominant-markets-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                        <!-- Market cards will be dynamically inserted here -->
                        <div class="col-span-full text-center text-gray-400 py-4" id="markets-loading-indicator">Loading dominant market data...</div>
                    </div>
                </section>

                <!-- Profile Section -->
                <section id="profile-section" class="content-section full-width panel-bg rounded-lg p-3 shadow-lg border border-color"> <!-- Reduced padding -->
                    <h2 class="text-base font-semibold text-white mb-2.5">My Profile</h2> <!-- Reduced font size and margin -->
                    <div class="text-gray-300 space-y-1.5"> <!-- Reduced space-y -->
                        <p class="text-sm"><strong>Name:</strong> John Doe</p> <!-- Reduced font size -->
                        <p class="text-sm"><strong>Account ID:</strong> 00000001</p>
                        <p class="text-sm"><strong>Email:</strong> john.doe@example.com</p>
                        <p class="text-sm"><strong>Membership Tier:</strong> Premium</p>
                        <p class="text-sm">Manage your personal information and account settings here.</p>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded-md mt-3 text-sm" onclick="showCustomMessage('Profile settings updated!');">Edit Profile</button> <!-- Reduced padding, margin-top, font size -->
                    </div>
                </section>

                <!-- Orders Section -->
                <section id="orders-section" class="content-section full-width panel-bg rounded-lg p-3 shadow-lg border border-color"> <!-- Reduced padding -->
                    <h2 class="text-base font-semibold text-white mb-2.5">My Orders</h2> <!-- Reduced font size and margin -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs text-gray-300"> <!-- Reduced font size -->
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="py-1.5 px-2.5 text-left">Symbol</th> <!-- Reduced padding -->
                                    <th class="py-1.5 px-2.5 text-left">Type</th>
                                    <th class="py-1.5 px-2.5 text-left">Quantity</th>
                                    <th class="py-1.5 px-2.5 text-left">Price</th>
                                    <th class="py-1.5 px-2.5 text-left">Status</th>
                                    <th class="py-1.5 px-2.5 text-left">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-gray-800">
                                    <td class="py-1.5 px-2.5">AAPL</td> <!-- Reduced padding -->
                                    <td class="py-1.5 px-2.5 text-green-500">BUY</td>
                                    <td class="py-1.5 px-2.5">10</td>
                                    <td class="py-1.5 px-2.5">$175.00</td>
                                    <td class="py-1.5 px-2.5 text-yellow-500">Pending</td>
                                    <td class="py-1.5 px-2.5">2025-07-18</td>
                                </tr>
                                <tr class="border-b border-gray-800">
                                    <td class="py-1.5 px-2.5">MSFT</td>
                                    <td class="py-1.5 px-2.5 text-red-500">SELL</td>
                                    <td class="py-1.5 px-2.5">5</td>
                                    <td class="py-1.5 px-2.5">$450.00</td>
                                    <td class="py-1.5 px-2.5 text-green-500">Executed</td>
                                    <td class="py-1.5 px-2.5">2025-07-17</td>
                                </tr>
                                <tr class="border-b border-gray-800">
                                    <td class="py-1.5 px-2.5">GOOGL</td>
                                    <td class="py-1.5 px-2.5 text-green-500">BUY</td>
                                    <td class="py-1.5 px-2.5">2</td>
                                    <td class="py-1.5 px-2.5">$1800.00</td>
                                    <td class="py-1.5 px-2.5 text-green-500">Executed</td>
                                    <td class="py-1.5 px-2.5">2025-07-16</td>
                                </tr>
                                <tr>
                                    <td class="py-1.5 px-2.5">TSLA</td>
                                    <td class="py-1.5 px-2.5 text-red-500">SELL</td>
                                    <td class="py-1.5 px-2.5">1</td>
                                    <td class="py-1.5 px-2.5">$280.00</td>
                                    <td class="py-1.5 px-2.5 text-yellow-500">Pending</td>
                                    <td class="py-1.5 px-2.5">2025-07-15</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Statistics Section -->
                <section id="statistics-section" class="content-section full-width panel-bg rounded-lg p-3 shadow-lg border border-color"> <!-- Reduced padding -->
                    <h2 class="text-base font-semibold text-white mb-2.5">Performance Statistics</h2> <!-- Reduced font size and margin -->
                    <div class="text-gray-300 space-y-1.5"> <!-- Reduced space-y -->
                        <p class="text-sm"><strong>Total Trades:</strong> 125</p> <!-- Reduced font size -->
                        <p class="text-sm"><strong>Win Rate:</strong> 68%</p>
                        <p class="text-sm"><strong>Average Gain per Trade:</strong> +$50.25</p>
                        <p class="text-sm"><strong>Largest Gain:</strong> +$500.00 (NVDA)</p>
                        <p class="text-sm"><strong>Largest Loss:</strong> -$150.00 (AMC)</p>
                        <p class="mt-3 text-sm">Detailed analytics and historical performance data are available here.</p> <!-- Reduced margin-top and font size -->
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded-md mt-3 text-sm" onclick="showCustomMessage('Generating detailed report...');">Generate Report</button> <!-- Reduced padding, margin-top, font size -->
                    </div>
                </section>

                <!-- History Section -->
                <section id="history-section" class="content-section full-width panel-bg rounded-lg p-3 shadow-lg border border-color"> <!-- Reduced padding -->
                    <h2 class="text-base font-semibold text-white mb-2.5">Transaction History</h2> <!-- Reduced font size and margin -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs text-gray-300"> <!-- Reduced font size -->
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="py-1.5 px-2.5 text-left">Date</th> <!-- Reduced padding -->
                                    <th class="py-1.5 px-2.5 text-left">Transaction</th>
                                    <th class="py-1.5 px-2.5 text-left">Amount</th>
                                    <th class="py-1.5 px-2.5 text-left">Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-gray-800">
                                    <td class="py-1.5 px-2.5">2025-07-18</td> <!-- Reduced padding -->
                                    <td class="py-1.5 px-2.5">Deposit</td>
                                    <td class="py-1.5 px-2.5 accent-green">$1,000.00</td>
                                    <td class="py-1.5 px-2.5">Bank Transfer</td>
                                </tr>
                                <tr class="border-b border-gray-800">
                                    <td class="py-1.5 px-2.5">2025-07-17</td>
                                    <td class="py-1.5 px-2.5">Trade</td>
                                    <td class="py-1.5 px-2.5 accent-green">+$50.00</td>
                                    <td class="py-1.5 px-2.5">MSFT Sale Profit</td>
                                </tr>
                                <tr class="border-b border-gray-800">
                                    <td class="py-1.5 px-2.5">2025-07-16</td>
                                    <td class="py-1.5 px-2.5">Withdrawal</td>
                                    <td class="py-1.5 px-2.5 accent-red">-$200.00</td>
                                    <td class="py-1.5 px-2.5">Personal Use</td>
                                </tr>
                                <tr>
                                    <td class="py-1.5 px-2.5">TSLA</td>
                                    <td class="py-1.5 px-2.5 text-red-500">SELL</td>
                                    <td class="py-1.5 px-2.5">1</td>
                                    <td class="py-1.5 px-2.5">$280.00</td>
                                    <td class="py-1.5 px-2.5 text-yellow-500">Pending</td>
                                    <td class="py-1.5 px-2.5">2025-07-15</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Deposit Section -->
                <section id="deposit-section" class="content-section full-width panel-bg rounded-lg p-3 shadow-lg border border-color"> <!-- Reduced padding -->
                    <h2 class="text-base font-semibold text-white mb-2.5">Deposit Funds</h2> <!-- Reduced font size and margin -->
                    <div class="space-y-2.5"> <!-- Reduced space-y -->
                        <div>
                            <label for="depositAmount" class="block text-gray-400 text-xs mb-0.5">Amount</label>
                            <input type="number" id="depositAmount" value="1000" class="w-full px-2.5 py-1.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white text-sm"> <!-- Reduced padding and font size -->
                        </div>
                        <div>
                            <label for="depositMethod" class="block text-gray-400 text-xs mb-0.5">Method</label>
                            <select id="depositMethod" class="w-full px-2.5 py-1.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white text-sm"> <!-- Reduced padding and font size -->
                                <option>Bank Transfer</option>
                                <option>Credit/Debit Card</option>
                                <option>PayPal</option>
                            </select>
                        </div>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded-md w-full text-sm" onclick="showCustomMessage('Deposit initiated!');">Confirm Deposit</button> <!-- Reduced padding and font size -->
                    </div>
                </section>

                <!-- Support Section -->
                <section id="support-section" class="content-section full-width panel-bg rounded-lg p-3 shadow-lg border border-color"> <!-- Reduced padding -->
                    <h2 class="text-base font-semibold text-white mb-2.5">Customer Support</h2> <!-- Reduced font size and margin -->
                    <div class="text-gray-300 space-y-1.5"> <!-- Reduced space-y -->
                        <p class="text-sm">If you need assistance, please contact our support team:</p> <!-- Reduced font size -->
                        <p class="text-sm"><strong>Email:</strong> support@apex.com</p>
                        <p class="text-sm"><strong>Phone:</strong> +1 (800) 123-4567</p>
                        <p class="text-sm"><strong>Live Chat:</strong> Available 24/7 (click below)</p>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded-md mt-3 text-sm" onclick="showCustomMessage('Connecting to live chat...');">Start Live Chat</button> <!-- Reduced padding, margin-top, font size -->
                    </div>
                </section>

                <!-- Privacy Policy Section -->
                <section id="privacy-policy-section" class="content-section full-width panel-bg rounded-lg p-3 shadow-lg border border-color"> <!-- Reduced padding -->
                    <h2 class="text-base font-semibold text-white mb-2.5">Privacy Policy</h2> <!-- Reduced font size and margin -->
                    <div class="text-gray-300 space-y-2 text-xs overflow-y-auto max-h-[calc(100vh-180px)]"> <!-- Reduced space-y, font size, and max-height -->
                        <p><strong>Effective Date:</strong> July 19, 2025</p>
                        <p>Welcome to APEX Investor Tool. We are committed to protecting your privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our platform.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">1. Information We Collect</h3> <!-- Reduced font size and margins -->
                        <p>We may collect personal information that you voluntarily provide to us when you register on the platform, place trades, link broker accounts, or contact us. This information may include:</p>
                        <ul class="list-disc list-inside ml-3 space-y-0.5"> <!-- Reduced margin-left and space-y -->
                            <li><strong>Personal Identifiers:</strong> Name, email address, phone number, account ID.</li>
                            <li><strong>Financial Information:</strong> Portfolio value, trade history, linked broker details (though we do not store your direct broker login credentials).</li>
                            <li><strong>Usage Data:</strong> Information about how you access and use the platform, including IP address, browser type, operating system, and pages viewed.</li>
                        </ul>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">2. How We Use Your Information</h3>
                        <p>We use the information we collect for various purposes, including:</p>
                        <ul class="list-disc list-inside ml-3 space-y-0.5">
                            <li>To provide, operate, and maintain our platform.</li>
                            <li>To process your transactions and manage your orders.</li>
                            <li>To personalize your experience and deliver tailored content.</li>
                            <li>To improve our platform, products, and services.</li>
                            <li>To communicate with you, including sending updates, security alerts, and support messages.</li>
                            <li>To monitor and analyze usage and trends to improve your experience.</li>
                            <li>To detect, prevent, and address technical issues or fraudulent activities.</li>
                        </ul>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">3. How We Share Your Information</h3>
                        <p>We may share your information with third parties only in the following circumstances:</p>
                        <ul class="list-disc list-inside ml-3 space-y-0.5">
                            <li><strong>With Your Consent:</strong> We may disclose your personal information when you give us explicit consent to do so.</li>
                            <li><strong>Service Providers:</strong> We may share your information with third-party vendors, service providers, contractors, or agents who perform services for us or on our behalf (e.g., data hosting, analytics, customer support).</li>
                            <li><strong>Legal Requirements:</strong> We may disclose your information if required to do so by law or in response to valid requests by public authorities (e.g., a court order or government agency).</li>
                            <li><strong>Business Transfers:</strong> In connection with, or during negotiations of, any merger, sale of company assets, financing, or acquisition of all or a portion of our business to another company.</li>
                        </ul>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">4. Data Security</h3>
                        <p>We implement a variety of security measures to maintain the safety of your personal information. However, no method of transmission over the Internet or method of electronic storage is 100% secure. While we strive to use commercially acceptable means to protect your personal information, we cannot guarantee its absolute security.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">5. Your Choices and Rights</h3>
                        <p>You have certain rights regarding your personal information, including the right to access, correct, or delete your data. Please contact us to exercise these rights.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">6. Changes to This Privacy Policy</h3>
                        <p>We may update our Privacy Policy from time to time. We will notify you of any changes by posting the new Privacy Policy on this page and updating the "Effective Date" at the top. You are advised to review this Privacy Policy periodically for any changes.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">7. Contact Us</h3>
                        <p>If you have any questions about this Privacy Policy, please contact us at support@apex.com.</p>
                    </div>
                </section>

                <!-- Terms of Service Section -->
                <section id="terms-of-service-section" class="content-section full-width panel-bg rounded-lg p-3 shadow-lg border border-color"> <!-- Reduced padding -->
                    <h2 class="text-base font-semibold text-white mb-2.5">Terms of Service</h2> <!-- Reduced font size and margin -->
                    <div class="text-gray-300 space-y-2 text-xs overflow-y-auto max-h-[calc(100vh-180px)]"> <!-- Reduced space-y, font size, and max-height -->
                        <p><strong>Effective Date:</strong> July 19, 2025</p>
                        <p>Welcome to APEX Investor Tool. These Terms of Service ("Terms") govern your access to and use of our investment advisory and broker-dealer simulation platform. By accessing or using the platform, you agree to be bound by these Terms.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">1. Services Provided</h3>
                        <p>APEX Investor Tool provides a simulated investment advisory and broker-dealer platform. This platform is designed for educational and informational purposes only. It allows users to:</p>
                        <ul class="list-disc list-inside ml-3 space-y-0.5">
                            <li>Access simulated market data and charts.</li>
                            <li>Practice placing simulated trades (buy/sell orders) for various assets.</li>
                            <li>Manage a simulated portfolio.</li>
                            <li>Access simulated market news and performance statistics.</li>
                        </ul>
                        <p class="font-bold text-red-400">IMPORTANT DISCLAIMER: This platform does NOT provide real investment advice, brokerage services, or facilitate actual financial transactions. All data, trades, and portfolio values are simulated and for demonstration purposes only. You cannot lose or gain real money through this platform.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">2. No Guarantees</h3>
                        <p class="font-bold text-red-400">INVESTMENT WARNING: There is no such thing as a guaranteed return in financial markets. All investments involve risk, including the potential loss of principal. Past performance, whether simulated or real, is not indicative of future results. The information and tools provided on this platform are for educational purposes and should not be considered financial advice. You should consult with a qualified financial professional before making any actual investment decisions.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">3. User Responsibilities</h3>
                        <p>By using our platform, you agree to:</p>
                        <ul class="list-disc list-inside ml-3 space-y-0.5">
                            <li>Use the platform only for its intended educational and simulated purposes.</li>
                            <li>Not attempt to manipulate or exploit the simulated environment.</li>
                            <li>Provide accurate and complete information when registering.</li>
                            <li>Maintain the confidentiality of your account credentials.</li>
                            <li>Comply with all applicable laws and regulations.</li>
                        </ul>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">4. Intellectual Property</h3>
                        <p>All content, features, and functionality on the APEX Investor Tool platform, including text, graphics, logos, and software, are the exclusive property of APEX Investor Tool and are protected by intellectual property laws.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">5. Limitation of Liability</h3>
                        <p>To the fullest extent permitted by applicable law, APEX Investor Tool shall not be liable for any indirect, incidental, special, consequential, or punitive damages, or any loss of profits or revenues, whether incurred directly or indirectly, or any loss of data, use, goodwill, or other intangible losses, resulting from (a) your access to or use of or inability to access or use the platform; (b) any conduct or content of any third party on the platform; or (c) unauthorized access, use, or alteration of your transmissions or content.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">6. Indemnification</h3>
                        <p>You agree to indemnify and hold harmless APEX Investor Tool and its affiliates, officers, agents, and employees from and against any claims, liabilities, damages, losses, and expenses, including, without limitation, reasonable attorney's fees and costs, arising out of or in any way connected with your access to or use of the platform or your violation of these Terms.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">7. Termination</h3>
                        <p>We may terminate or suspend your access to our platform immediately, without prior notice or liability, for any reason whatsoever, including without limitation if you breach these Terms.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">8. Governing Law</h3>
                        <p>These Terms shall be governed and construed in accordance with the laws of [Your Jurisdiction, e.g., the State of California], without regard to its conflict of law provisions.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">9. Changes to Terms</h3>
                        <p>We reserve the right, at our sole discretion, to modify or replace these Terms at any time. If a revision is material, we will provide at least 30 days' notice prior to any new terms taking effect. By continuing to access or use our platform after those revisions become effective, you agree to be bound by the revised terms.</p>

                        <h3 class="text-sm font-semibold text-white mt-2 mb-1">10. Contact Information</h3>
                        <p>If you have any questions about these Terms, please contact us at support@apex.com.</p>
                    </div>
                </section>
            </div>

            <!-- Right Market List Column -->
            <aside class="market-list-column panel-bg rounded-lg p-3 shadow-lg border-l border-color"> <!-- Reduced padding -->
                <div class="flex justify-between items-center mb-1.5"> <!-- Reduced margin -->
                    <h2 class="text-base font-semibold text-white">Live Market Data</h2> <!-- Reduced font size -->
                    <button class="text-gray-400 hover:text-white text-xs">Filter</button> <!-- Reduced font size -->
                </div>
                <!-- Adjusted search input positioning -->
                <div class="relative w-full mb-2.5">
                    <!-- Increased pr (padding-right) to give more space for the icon -->
                    <input type="text" placeholder="Search Markets" class="w-full pl-2.5 pr-10 py-1.5 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white text-sm market-search-input">
                    <!-- Icon positioned absolutely to the right -->
                    <svg class="absolute right-2.5 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <div class="overflow-y-auto flex-1 text-sm" id="liveMarketDataList"> <!-- Reduced font size -->
                    <!-- Live market data will be populated here by JavaScript -->
                    <ul class="space-y-0.5"> <!-- Reduced space-y -->
                        <li><p class="text-gray-400 text-center py-1">Loading market data...</p></li> <!-- Reduced padding -->
                    </ul>
                </div>
            </aside>

        </div>

        <!-- Bottom Bar -->
        <footer class="bg-[#2A2A2A] p-1.5 flex items-center justify-between text-xs text-gray-400 flex-shrink-0 h-8"> <!-- Reduced padding and height -->
            <div class="flex items-center space-x-3"> <!-- Reduced space-x -->
                <span>© 2025 APEX Investor Tool. All rights reserved.</span>
                <span>Market data delayed by 15 minutes.</span>
            </div>
            <div class="flex items-center space-x-3"> <!-- Reduced space-x -->
                <a href="#" class="hover:underline" data-target="privacy-policy">Privacy Policy</a>
                <a href="#" class="hover:underline" data-target="terms-of-service">Terms of Service</a>
                <a href="#" class="hover:underline" data-target="support">Contact Support</a>
            </div>
        </footer>
    </div>

    <!-- Live Chat Button -->
    <div id="live-chat-button" class="fixed bottom-4 right-4 bg-blue-600 text-white rounded-full p-3 shadow-lg cursor-pointer hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg> <!-- Reduced size -->
    </div>

    <!-- Live Chat Window -->
    <div id="chat-window" class="hidden fixed bottom-16 right-4 bg-[#252525] rounded-lg shadow-xl flex flex-col z-50 border border-color">
        <div class="chat-header bg-[#2A2A2A] text-white p-3 flex justify-between items-center rounded-t-lg">
            <span>AI Chat Assistant</span>
            <button id="close-chat-btn" class="text-white text-xl leading-none px-1 hover:text-gray-400">&times;</button>
        </div>
        <div class="chat-messages flex-1 overflow-y-auto p-3 space-y-2" id="chat-messages">
            <!-- Chat messages will be appended here -->
            <div class="chat-message ai bg-gray-700 text-white p-2 rounded-lg self-start max-w-[80%]">Hello! How can I assist you with the APEX Investor Tool today?</div>
        </div>
        <div class="chat-input-area p-3 border-t border-gray-700 flex">
            <input type="text" id="chat-input" class="flex-1 p-2 rounded-md input-bg border border-color focus:outline-none focus:ring-1 focus:ring-blue-500 text-white" placeholder="Type your message...">
            <button id="send-chat-btn" class="ml-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">Send</button>
        </div>
    </div>

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            updateDoc // Added for updating portfolio
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        // IMPORTANT: In a real production environment, these should be loaded securely
        // from environment variables or a server, not hardcoded in client-side JS.
        // For Canvas, __firebase_config and __app_id are provided globally.
        const firebaseConfig = {
            apiKey: "AIzaSyAdIUF9wklnnSfIAeGlA3aw8UVCj0H0Vig",
            authDomain: "the-apex-app.firebaseapp.com",
            projectId: "the-apex-app",
            storageBucket: "the-apex-app.firebasestorage.app",
            messagingSenderId: "908808650183",
            appId: "1:908808650183:web:8112f608dd48c8140e6de2",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // FMP API Key (Placeholder - for production, manage securely)
        const FMP_API_KEY = "6uFHicw1PX5heQjTn6N2JlCRE73K1kV8";
        const FMP_BASE_URL = "https://financialmodelingprep.com/api/v3";

        // Global variables for intervals to clear them on logout
        let newsInterval;
        let marketDataInterval;
        let portfolioUpdateInterval; // New interval for portfolio prices
        let dominantMarketsInterval; // New interval for dominant markets

        // DOM Elements for Authentication
        const authContainer = document.getElementById('auth-container');
        const appContent = document.getElementById('app-content');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const authStatusMessage = document.getElementById('auth-status-message');

        // DOM Elements for Chat
        const liveChatButton = document.getElementById('live-chat-button');
        const chatWindow = document.getElementById('chat-window');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');

        // Trade Symbol Autocomplete elements
        const tradeSymbolInput = document.getElementById('tradeSymbol');
        const symbolSuggestionsList = document.getElementById('symbolSuggestions');

        // Portfolio elements
        const portfolioNameInput = document.getElementById('portfolioNameInput'); // New element for portfolio name
        const portfolioSymbolInput = document.getElementById('portfolioSymbol');
        const portfolioQuantityInput = document.getElementById('portfolioQuantity');
        const portfolioPurchasePriceInput = document.getElementById('portfolioPurchasePrice');
        const addAssetBtn = document.getElementById('addAssetBtn');
        const portfolioHoldingsTableBody = document.getElementById('portfolioHoldingsTableBody');
        const portfolioSymbolSuggestionsList = document.getElementById('portfolioSymbolSuggestions');
        const totalPortfolioValueDisplay = document.getElementById('total-portfolio-value');

        // Dashboard Portfolio Summary Elements (new IDs)
        const dashboardTotalInvested = document.getElementById('dashboard-total-invested');
        const dashboardCurrentValue = document.getElementById('dashboard-current-value');
        const dashboardOverallGainLossPercent = document.getElementById('dashboard-overall-gain-loss-percent');

        const portfolioSummaryInvested = document.getElementById('portfolioSummaryInvested');
        const portfolioSummaryCurrentValue = document.getElementById('portfolioSummaryCurrentValue');
        const portfolioSummaryGainLoss = document.getElementById('portfolioSummaryGainLoss');
        const portfolioAssetCount = document.getElementById('portfolioAssetCount');
        const buildPortfolioButton = document.getElementById('build-portfolio-btn');
        const portfolioLoadingIndicator = document.getElementById('portfolio-loading-indicator');
        const currentPortfolioNameDisplay = document.getElementById('currentPortfolioName');

        // Markets section elements
        const dominantMarketsGrid = document.getElementById('dominant-markets-grid');
        const marketsLoadingIndicator = document.getElementById('markets-loading-indicator');


        // Chat history for AI context
        let chatHistory = [{ role: "model", parts: [{ text: "Hello! How can I assist you with the APEX Investor Tool today?" }] }];

        // User's portfolio data (local state)
        let userPortfolio = {
            name: "Default Portfolio", // Default name
            assets: [] // Array of {symbol, quantity, purchasePrice, currentPrice, lastUpdated}
        };

        // Custom message box function (replaces alert())
        function showCustomMessage(message, isError = false) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: ${isError ? '#D50000' : '#2196F3'};
                color: #FFFFFF;
                padding: 15px; /* Reduced padding */
                border-radius: 6px; /* Reduced border radius */
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5); /* Reduced shadow */
                z-index: 1000;
                font-family: 'Inter', sans-serif;
                text-align: center;
                max-width: 280px; /* Reduced max width */
                font-size: 0.9rem; /* Reduced font size */
            `;
            messageBox.innerHTML = `
                <p class="mb-3">${message}</p> <!-- Reduced margin -->
                <button class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-1.5 px-3 rounded-md text-sm" onclick="this.parentNode.remove()">OK</button> <!-- Reduced padding and font size -->
            `;
            document.body.appendChild(messageBox);
        }

        // --- Authentication Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                console.log("User logged in:", user.email, "UID:", user.uid);

                // 1. Hide auth container and show app content immediately
                authContainer.classList.add('hidden');
                appContent.classList.remove('hidden');

                // 2. Clear the authentication status message
                authStatusMessage.textContent = "";
                authStatusMessage.classList.remove('error');

                // 3. Show a success message (optional, but good UX)
                showCustomMessage("Login successful!");

                // 4. Clear any previous intervals to prevent duplicates on re-login
                clearInterval(newsInterval);
                clearInterval(marketDataInterval);
                clearInterval(portfolioUpdateInterval);
                clearInterval(dominantMarketsInterval); // Clear new interval

                // 5. Initialize chart, news, and live market data
                fetchMarketNews();
                fetchLiveMarketData();
                fetchDominantMarketsData(); // Fetch dominant market data
                await loadUserPortfolio(user.uid); // Load portfolio after login

                // 6. Set up periodic updates
                newsInterval = setInterval(fetchMarketNews, 60000); // Refresh news every 60 seconds
                marketDataInterval = setInterval(fetchLiveMarketData, 15000); // Refresh live market data every 15 seconds
                portfolioUpdateInterval = setInterval(updatePortfolioPrices, 30000); // Refresh portfolio prices every 30 seconds
                dominantMarketsInterval = setInterval(fetchDominantMarketsData, 60000); // Refresh dominant market data every 60 seconds

                // 7. Ensure dashboard section is active
                showSection('dashboard-section');

            } else {
                // User is signed out, show authentication form
                console.log("User logged out or not authenticated.");
                authContainer.classList.remove('hidden');
                appContent.classList.add('hidden');

                // Clear intervals when user logs out
                clearInterval(newsInterval);
                clearInterval(marketDataInterval);
                clearInterval(portfolioUpdateInterval);
                clearInterval(dominantMarketsInterval); // Clear new interval

                // Reset auth message when logged out
                authStatusMessage.textContent = "Please log in or create an account.";
                authStatusMessage.classList.remove('error');

                // Clear local portfolio data and name
                userPortfolio = { name: "Default Portfolio", assets: [] };
                renderPortfolio(); // Clear the displayed portfolio
                updateOverallPortfolioSummary(); // Reset summary values
            }
        });

        loginBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            if (!email || !password) {
                authStatusMessage.textContent = "Please enter both email and password.";
                authStatusMessage.classList.add('error');
                return;
            }
            authStatusMessage.textContent = "Logging in...";
            authStatusMessage.classList.remove('error');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle UI update and data fetching
            } catch (error) {
                console.error("Login error:", error.code, error.message);
                let errorMessage = "Login failed. Please check your credentials.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = "Invalid email or password.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many login attempts. Please try again later.";
                }
                authStatusMessage.textContent = errorMessage;
                authStatusMessage.classList.add('error');
            }
        });

        // Modified signupBtn event listener to redirect to the external sign-up page
        signupBtn.addEventListener('click', () => {
            // Redirect to the external sign-up page
            window.location.href = 'https://theapexinvestor.net/sign-up';
        });

        // Handle logout
        document.addEventListener('click', async (event) => {
            // Check if the clicked element or any of its parents have the ID 'logout-btn'
            const logoutButton = event.target.closest('#logout-btn');
            if (logoutButton) {
                console.log("Logout button clicked.");
                console.log("Current Firebase user before signOut:", auth.currentUser);
                try {
                    await signOut(auth);
                    console.log("Firebase signOut successful.");
                    showCustomMessage("You have been logged out.");
                } catch (error) {
                    console.error("Error signing out from Firebase:", error);
                    showCustomMessage("Failed to log out. Please try again.", true);
                }
            }
        });

        // Function to fetch market news
        async function fetchMarketNews() {
            const newsListElement = document.getElementById('recentMarketNewsList');
            if (!newsListElement) {
                console.error("News list element not found.");
                return;
            }
            newsListElement.innerHTML = '<ul class="space-y-1.5"><li><p class="text-gray-400 text-center py-1">Loading market news...</p></li></ul>';

            try {
                const defaultNewsSymbol = "SPY"; // Example symbol for news
                const newsApiUrl = `${FMP_BASE_URL}/stock_news?tickers=${defaultNewsSymbol}&limit=10&apikey=${FMP_API_KEY}`;
                console.log("Fetching market news from:", newsApiUrl);
                const response = await fetch(newsApiUrl);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`HTTP error fetching news! Status: ${response.status}, Response: ${errorText}`);
                    throw new Error(`Failed to fetch news: ${response.status} - ${errorText}`);
                }
                const newsData = await response.json();
                console.log("Market news data received:", newsData);

                if (newsData && newsData.length > 0) {
                    newsListElement.innerHTML = '<ul class="space-y-1.5">' + newsData.map(news => `
                        <li class="py-0.5 border-b border-gray-700 last:border-b-0">
                            <p class="text-white font-medium text-sm">${news.title}</p>
                            <p class="text-xs text-gray-400">${news.text ? news.text.substring(0, 100) + '...' : 'No description available.'}</p>
                            <a href="${news.url}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline text-xs">Read more</a>
                        </li>
                    `).join('') + '</ul>';
                } else {
                    newsListElement.innerHTML = '<ul class="space-y-1.5"><li><p class="text-gray-400 text-center py-1">No recent news available.</p></li></ul>';
                }
            } catch (error) {
                console.error("Error fetching market news:", error);
                newsListElement.innerHTML = '<ul class="space-y-1.5"><li><p class="text-red-400 text-center py-1">Failed to load news. Please check API key or network connection.</p></li></ul>';
            }
        }

        // Function to fetch live market data for the right column
        async function fetchLiveMarketData() {
            const marketListElement = document.getElementById('liveMarketDataList');
            if (!marketListElement) {
                console.error("Live market data list element not found.");
                return;
            }
            marketListElement.innerHTML = '<ul class="space-y-0.5"><li><p class="text-gray-400 text-center py-1">Loading market data...</p></li></ul>';

            try {
                // Requested symbols: S&P 500 futures, Nasdaq futures, Gold, Silver, Bitcoin, Eth
                // Using common ETFs/Forex/Crypto pairs as proxies for simplicity with FMP API
                const symbols = ["SPY", "QQQ", "XAUUSD", "XAGUSD", "BTCUSD", "ETHUSD"];
                const marketDataUrl = `${FMP_BASE_URL}/quote/${symbols.join(',')}?apikey=${FMP_API_KEY}`;
                console.log("Fetching live market data from:", marketDataUrl);
                const response = await fetch(marketDataUrl);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`HTTP error fetching market data! Status: ${response.status}, Response: ${errorText}`);
                    throw new Error(`Failed to fetch market data: ${response.status} - ${errorText}`);
                }
                const data = await response.json();
                console.log("Live market data received:", data);

                if (data && data.length > 0) {
                    marketListElement.innerHTML = '<ul class="space-y-0.5">' + data.map(item => {
                        const isPositive = parseFloat(item.changesPercentage) >= 0;
                        const changeClass = isPositive ? 'accent-green' : 'accent-red';
                        // Store price and percentage in data attributes for toggling
                        return `
                            <li class="flex justify-between items-center py-0.5 border-b border-gray-700 last:border-b-0 cursor-pointer"
                                data-symbol="${item.symbol}"
                                data-price="${item.price?.toFixed(2) || 'N/A'}"
                                data-percentage="${item.changesPercentage?.toFixed(2) || 'N/A'}%"
                                data-display-mode="percentage">
                                <span class="text-white font-semibold text-sm">${item.symbol}</span>
                                <span class="${changeClass} font-semibold market-value-toggle text-sm" data-current-value="${item.changesPercentage?.toFixed(2) || 'N/A'}%">${item.changesPercentage?.toFixed(2) || 'N/A'}%</span>
                            </li>
                        `;
                    }).join('') + '</ul>';
                } else {
                    marketListElement.innerHTML = '<ul class="space-y-0.5"><li><p class="text-gray-400 text-center py-1">No live market data available.</p></li></ul>';
                }
            } catch (error) {
                console.error("Error fetching live market data:", error);
                marketListElement.innerHTML = '<ul class="space-y-0.5"><li><p class="text-red-400 text-center py-1">Failed to load market data. Please check API key or network connection.</p></li></ul>';
            }
        }

        // Event listener for toggling price/percentage in Live Market Data
        document.getElementById('liveMarketDataList').addEventListener('click', function(event) {
            const clickedElement = event.target.closest('li');
            if (clickedElement && clickedElement.dataset.price && clickedElement.dataset.percentage) {
                const currentMode = clickedElement.dataset.displayMode;
                const valueSpan = clickedElement.querySelector('.market-value-toggle');

                if (currentMode === 'percentage') {
                    valueSpan.textContent = `$${clickedElement.dataset.price}`;
                    clickedElement.dataset.displayMode = 'price';
                } else {
                    valueSpan.textContent = `${clickedElement.dataset.percentage}`;
                    clickedElement.dataset.displayMode = 'percentage';
                }
            }
        });


        // Function to switch content sections
        function showSection(sectionId) {
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
                // For dashboard section, remove the grid layout when not active
                if (section.id === 'dashboard-section') {
                    section.classList.remove('grid', 'grid-cols-1', 'lg:grid-cols-2', 'grid-rows-1', 'lg:grid-rows-2');
                }
            });

            // Show the requested section
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.add('active');
                // For dashboard section, add the grid layout when active
                if (sectionId === 'dashboard-section') {
                    activeSection.classList.add('grid', 'grid-cols-1', 'lg:grid-cols-2', 'grid-rows-1', 'lg:grid-rows-2');
                }
            }

            // Update active state for sidebar links (and now footer links too)
            document.querySelectorAll('.nav-link-sidebar, .nav-link, footer a').forEach(link => {
                const linkTargetId = link.dataset.target ? (link.dataset.target.includes('-section') ? link.dataset.target : link.dataset.target + '-section') : null;

                if (linkTargetId === sectionId) {
                    link.classList.add('bg-blue-600', 'text-white');
                    link.classList.remove('text-gray-400', 'hover:bg-gray-700');
                } else {
                    link.classList.remove('bg-blue-600', 'text-white');
                    link.classList.add('text-gray-400', 'hover:bg-gray-700');
                }
            });

            // If navigating to portfolio, ensure it's up to date
            if (sectionId === 'portfolio-section' && auth.currentUser) {
                loadUserPortfolio(auth.currentUser.uid);
            }
            // If navigating to markets, fetch data
            if (sectionId === 'markets-section') {
                fetchDominantMarketsData();
            }
        }


        // Handle navigation clicks (top bar and sidebar)
        document.querySelectorAll('.nav-link, .nav-link-sidebar').forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault(); // Prevent default link behavior
                const targetId = this.dataset.target + '-section';
                showSection(targetId);
            });
        });

        // Handle footer link clicks
        document.querySelectorAll('footer a').forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault(); // Prevent default link behavior
                const targetId = this.dataset.target + '-section'; // Append -section to match content section IDs
                showSection(targetId);
            });
        });

        // Handle "Send Order to Broker" button click
        function sendOrderToBroker() {
            const symbol = document.getElementById('tradeSymbol').value;
            const type = document.getElementById('tradeType').value;
            const quantity = document.getElementById('tradeQuantity').value;
            const broker = document.getElementById('targetBroker').value;

            if (!symbol || !quantity || quantity <= 0) {
                showCustomMessage("Please enter a valid symbol and quantity.");
                return;
            }

            showCustomMessage(`Sending ${quantity} units of ${symbol} to ${broker} for ${type} transaction.`);
        }

        // --- Autocomplete for Trade Symbol ---
        let tradeAutocompleteTimeout;
        tradeSymbolInput.addEventListener('input', function() {
            clearTimeout(tradeAutocompleteTimeout); // Clear previous timeout
            const input = this.value.toUpperCase();
            symbolSuggestionsList.innerHTML = ''; // Clear previous suggestions

            if (input.length === 0) {
                symbolSuggestionsList.classList.add('hidden');
                return;
            }

            tradeAutocompleteTimeout = setTimeout(async () => {
                try {
                    // Fetch symbols from FMP API, searching NYSE and NASDAQ
                    const searchApiUrl = `${FMP_BASE_URL}/search?query=${input}&limit=10&exchange=NYSE,NASDAQ&apikey=${FMP_API_KEY}`;
                    console.log("Fetching autocomplete suggestions from:", searchApiUrl);
                    const response = await fetch(searchApiUrl);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`HTTP error fetching symbols! Status: ${response.status}, Response: ${errorText}`);
                        throw new Error(`Failed to fetch symbols: ${response.status} - ${errorText}`);
                    }
                    const data = await response.json();
                    console.log("Autocomplete data received:", data);

                    if (data && data.length > 0) {
                        data.forEach(item => {
                            const li = document.createElement('li');
                            li.classList.add('p-1.5', 'text-gray-200', 'hover:bg-blue-800', 'hover:text-white', 'cursor-pointer', 'transition-colors', 'duration-200');
                            li.textContent = `${item.symbol} - ${item.name} (${item.exchangeShortName})`;
                            li.dataset.symbol = item.symbol; // Store just the symbol
                            li.addEventListener('mousedown', function() { // Use mousedown to prevent blur from hiding it too soon
                                tradeSymbolInput.value = this.dataset.symbol;
                                symbolSuggestionsList.classList.add('hidden');
                            });
                            symbolSuggestionsList.appendChild(li);
                        });
                        symbolSuggestionsList.classList.remove('hidden');
                    } else {
                        symbolSuggestionsList.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Error fetching autocomplete symbols:", error);
                    symbolSuggestionsList.innerHTML = '<li class="text-red-400 p-1.5">Failed to load suggestions.</li>';
                    symbolSuggestionsList.classList.remove('hidden');
                }
            }, 300); // Debounce API call by 300ms
        });

        // Hide suggestions when input loses focus (with a slight delay)
        tradeSymbolInput.addEventListener('blur', function() {
            setTimeout(() => {
                symbolSuggestionsList.classList.add('hidden');
            }, 100); // Small delay to allow click on suggestion to register
        });


        // --- Portfolio Management Logic ---

        // Autocomplete for Portfolio Symbol Input
        let portfolioAutocompleteTimeout;
        portfolioSymbolInput.addEventListener('input', function() {
            clearTimeout(portfolioAutocompleteTimeout);
            const input = this.value.toUpperCase();
            portfolioSymbolSuggestionsList.innerHTML = '';

            if (input.length === 0) {
                portfolioSymbolSuggestionsList.classList.add('hidden');
                return;
            }

            portfolioAutocompleteTimeout = setTimeout(async () => {
                try {
                    const searchApiUrl = `${FMP_BASE_URL}/search?query=${input}&limit=10&exchange=NYSE,NASDAQ,FOREX,CRYPTO&apikey=${FMP_API_KEY}`;
                    const response = await fetch(searchApiUrl);
                    if (!response.ok) throw new Error(`FMP Search API HTTP error: ${response.status}`);
                    const data = await response.json();

                    if (data && data.length > 0) {
                        data.forEach(item => {
                            const li = document.createElement('li');
                            li.classList.add('p-1.5', 'text-gray-200', 'hover:bg-blue-800', 'hover:text-white', 'cursor-pointer', 'transition-colors', 'duration-200');
                            li.textContent = `${item.symbol} - ${item.name} (${item.exchangeShortName || item.currency})`;
                            li.dataset.symbol = item.symbol;
                            li.addEventListener('mousedown', function() {
                                portfolioSymbolInput.value = this.dataset.symbol;
                                portfolioSymbolSuggestionsList.classList.add('hidden');
                            });
                            portfolioSymbolSuggestionsList.appendChild(li);
                        });
                        portfolioSymbolSuggestionsList.classList.remove('hidden');
                    } else {
                        portfolioSymbolSuggestionsList.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Error fetching portfolio autocomplete symbols:", error);
                    portfolioSymbolSuggestionsList.innerHTML = '<li class="text-red-400 p-1.5">Failed to load suggestions.</li>';
                    portfolioSymbolSuggestionsList.classList.remove('hidden');
                }
            }, 300);
        });

        portfolioSymbolInput.addEventListener('blur', function() {
            setTimeout(() => {
                portfolioSymbolSuggestionsList.classList.add('hidden');
            }, 100);
        });

        // Function to load user portfolio from Firestore
        async function loadUserPortfolio(userId) {
            if (!userId) {
                console.error("No user ID available to load portfolio.");
                userPortfolio = { name: "Default Portfolio", assets: [] };
                renderPortfolio();
                updateOverallPortfolioSummary();
                return;
            }
            try {
                const portfolioDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/portfolios/default`);
                const docSnap = await getDoc(portfolioDocRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userPortfolio.assets = data.assets || [];
                    userPortfolio.name = data.name || "Default Portfolio";
                    console.log("Portfolio loaded:", userPortfolio);
                } else {
                    userPortfolio = { name: "Default Portfolio", assets: [] };
                    console.log("No portfolio found for user, initializing empty.");
                }
                // Update the portfolio name input and display
                portfolioNameInput.value = userPortfolio.name;
                currentPortfolioNameDisplay.textContent = userPortfolio.name;

                // After loading, update prices and render
                await updatePortfolioPrices();
                renderPortfolio();
                updateOverallPortfolioSummary();
            } catch (error) {
                console.error("Error loading portfolio:", error);
                showCustomMessage("Failed to load your portfolio. Please try again.", true);
                userPortfolio = { name: "Default Portfolio", assets: [] }; // Ensure portfolio is empty on error
                renderPortfolio();
                updateOverallPortfolioSummary();
            }
        }

        // Function to save user portfolio to Firestore
        async function saveUserPortfolio(userId) {
            if (!userId) {
                console.error("No user ID available to save portfolio.");
                showCustomMessage("Cannot save portfolio: User not logged in.", true);
                return;
            }
            try {
                const portfolioDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/portfolios/default`);
                await setDoc(portfolioDocRef, { assets: userPortfolio.assets, name: userPortfolio.name });
                console.log("Portfolio saved successfully!");
                showCustomMessage("Portfolio saved successfully!");
            } catch (error) {
                console.error("Error saving portfolio:", error);
                showCustomMessage("Failed to save portfolio. Please try again.", true);
            }
        }

        // Event listener for portfolio name input change
        portfolioNameInput.addEventListener('change', async () => {
            if (auth.currentUser) {
                userPortfolio.name = portfolioNameInput.value.trim() || "Default Portfolio";
                currentPortfolioNameDisplay.textContent = userPortfolio.name;
                await saveUserPortfolio(auth.currentUser.uid);
            }
        });


        // Function to add an asset to the portfolio
        addAssetBtn.addEventListener('click', async () => {
            const symbol = portfolioSymbolInput.value.toUpperCase().trim();
            const quantity = parseFloat(portfolioQuantityInput.value);
            const purchasePrice = parseFloat(portfolioPurchasePriceInput.value);

            if (!symbol || isNaN(quantity) || quantity <= 0 || isNaN(purchasePrice) || purchasePrice < 0) {
                showCustomMessage("Please enter a valid symbol, quantity, and purchase price.", true);
                return;
            }

            if (!auth.currentUser) {
                showCustomMessage("Please log in to add assets to your portfolio.", true);
                return;
            }

            // Check if asset already exists, if so, update quantity and average price
            const existingAssetIndex = userPortfolio.assets.findIndex(asset => asset.symbol === symbol);

            if (existingAssetIndex > -1) {
                const existingAsset = userPortfolio.assets[existingAssetIndex];
                const newTotalInvested = (existingAsset.quantity * existingAsset.purchasePrice) + (quantity * purchasePrice);
                const newTotalQuantity = existingAsset.quantity + quantity;
                existingAsset.quantity = newTotalQuantity;
                existingAsset.purchasePrice = newTotalInvested / newTotalQuantity; // Calculate new average purchase price
                existingAsset.lastUpdated = new Date().toISOString(); // Update timestamp
                showCustomMessage(`Updated ${symbol} quantity to ${newTotalQuantity}.`);
            } else {
                userPortfolio.assets.push({
                    symbol: symbol,
                    quantity: quantity,
                    purchasePrice: purchasePrice,
                    currentPrice: 0, // Will be updated by fetchCurrentPricesForPortfolio
                    lastUpdated: new Date().toISOString()
                });
                showCustomMessage(`Added ${symbol} to your portfolio.`);
            }

            // Clear input fields
            portfolioSymbolInput.value = '';
            portfolioQuantityInput.value = '1';
            portfolioPurchasePriceInput.value = '0.00';

            await saveUserPortfolio(auth.currentUser.uid);
            await updatePortfolioPrices(); // Update prices for the new/updated asset
            renderPortfolio();
            updateOverallPortfolioSummary();
        });

        // Function to remove an asset from the portfolio
        async function removeAsset(symbolToRemove) {
            if (!auth.currentUser) {
                showCustomMessage("Please log in to modify your portfolio.", true);
                return;
            }

            // Filter out the asset to be removed
            userPortfolio.assets = userPortfolio.assets.filter(asset => asset.symbol !== symbolToRemove);
            showCustomMessage(`Removed ${symbolToRemove} from your portfolio.`);

            // Save the updated portfolio to Firestore
            await saveUserPortfolio(auth.currentUser.uid);

            // Re-render the UI
            renderPortfolio();
            updateOverallPortfolioSummary();
        }
        // Make removeAsset globally accessible for onclick in HTML
        window.removeAsset = removeAsset;


        // Function to fetch current prices for all assets in the portfolio
        async function updatePortfolioPrices() {
            if (userPortfolio.assets.length === 0) {
                console.log("No assets in portfolio to update prices.");
                return;
            }

            portfolioLoadingIndicator.classList.remove('hidden'); // Show loading indicator

            const symbolsToFetch = userPortfolio.assets.map(asset => asset.symbol).join(',');
            try {
                const quoteUrl = `${FMP_BASE_URL}/quote/${symbolsToFetch}?apikey=${FMP_API_KEY}`;
                const response = await fetch(quoteUrl);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`FMP Quote API HTTP error: ${response.status} - ${errorText}`);
                }
                const data = await response.json();

                if (data && data.length > 0) {
                    data.forEach(apiItem => {
                        const portfolioAsset = userPortfolio.assets.find(asset => asset.symbol === apiItem.symbol);
                        if (portfolioAsset) {
                            portfolioAsset.currentPrice = apiItem.price;
                        }
                    });
                    renderPortfolio(); // Re-render the table with updated prices
                    updateOverallPortfolioSummary(); // Update summary with new values
                } else {
                    console.warn("No current price data returned for portfolio assets.");
                    // Display a temporary message if no data is returned
                    portfolioHoldingsTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-2 text-yellow-400">Could not fetch current prices for all assets.</td></tr>' + portfolioHoldingsTableBody.innerHTML;
                }
            } catch (error) {
                console.error("Error updating portfolio prices:", error);
                // Display a temporary error message in the table
                portfolioHoldingsTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-2 text-red-400">Failed to update prices. Check API key or network.</td></tr>' + portfolioHoldingsTableBody.innerHTML;
            } finally {
                portfolioLoadingIndicator.classList.add('hidden'); // Hide loading indicator
            }
        }

        // Function to render the portfolio table
        function renderPortfolio() {
            portfolioHoldingsTableBody.innerHTML = ''; // Clear existing rows

            if (userPortfolio.assets.length === 0) {
                portfolioHoldingsTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-2 text-gray-400">No assets in your portfolio yet. Add some above!</td></tr>';
                return;
            }

            userPortfolio.assets.forEach(asset => {
                const totalInvested = asset.quantity * asset.purchasePrice;
                const currentValue = asset.quantity * asset.currentPrice;
                const gainLoss = currentValue - totalInvested;
                const gainLossPercent = totalInvested > 0 ? (gainLoss / totalInvested) * 100 : 0;

                const gainLossClass = gainLoss >= 0 ? 'accent-green' : 'accent-red';

                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-800');
                row.innerHTML = `
                    <td class="py-1.5 px-2.5 text-white font-semibold">${asset.symbol}</td>
                    <td class="py-1.5 px-2.5">${asset.quantity.toFixed(2)}</td>
                    <td class="py-1.5 px-2.5">$${asset.purchasePrice.toFixed(2)}</td>
                    <td class="py-1.5 px-2.5">$${asset.currentPrice.toFixed(2)}</td>
                    <td class="py-1.5 px-2.5">$${totalInvested.toFixed(2)}</td>
                    <td class="py-1.5 px-2.5">$${currentValue.toFixed(2)}</td>
                    <td class="py-1.5 px-2.5 ${gainLossClass}">$${gainLoss.toFixed(2)}</td>
                    <td class="py-1.5 px-2.5 ${gainLossClass}">${gainLossPercent.toFixed(2)}%</td>
                    <td class="py-1.5 px-2.5">
                        <button class="text-red-500 hover:text-red-700 text-xs font-semibold" onclick="removeAsset('${asset.symbol}')">Remove</button>
                    </td>
                `;
                portfolioHoldingsTableBody.appendChild(row);
            });
        }

        // Function to update overall portfolio summary
        function updateOverallPortfolioSummary() {
            let totalInvested = 0;
            let currentTotalValue = 0;

            userPortfolio.assets.forEach(asset => {
                totalInvested += asset.quantity * asset.purchasePrice;
                currentTotalValue += asset.quantity * asset.currentPrice;
            });

            const overallGainLoss = currentTotalValue - totalInvested;
            const overallGainLossPercent = totalInvested > 0 ? (overallGainLoss / totalInvested) * 100 : 0;

            // Update elements in the Portfolio Section (My Holdings)
            portfolioSummaryInvested.textContent = `$${totalInvested.toFixed(2)}`;
            portfolioSummaryCurrentValue.textContent = `$${currentTotalValue.toFixed(2)}`;
            portfolioSummaryGainLoss.textContent = `$${overallGainLoss.toFixed(2)} (${overallGainLossPercent.toFixed(2)}%)`;
            portfolioSummaryGainLoss.classList.remove('accent-green', 'accent-red', 'text-white'); // Reset classes
            if (overallGainLoss > 0) {
                portfolioSummaryGainLoss.classList.add('accent-green');
            } else if (overallGainLoss < 0) {
                portfolioSummaryGainLoss.classList.add('accent-red');
            } else {
                portfolioSummaryGainLoss.classList.add('text-white');
            }
            portfolioAssetCount.textContent = userPortfolio.assets.length;

            // Update elements in the Dashboard Portfolio Overview
            totalPortfolioValueDisplay.textContent = `$${currentTotalValue.toFixed(2)}`; // Header total value
            dashboardTotalInvested.textContent = `$${totalInvested.toFixed(2)}`;
            dashboardCurrentValue.textContent = `$${currentTotalValue.toFixed(2)}`;
            dashboardOverallGainLossPercent.textContent = `${overallGainLossPercent.toFixed(2)}%`;
            dashboardOverallGainLossPercent.classList.remove('accent-green', 'accent-red', 'text-white');
            if (overallGainLossPercent > 0) {
                dashboardOverallGainLossPercent.classList.add('accent-green');
            } else if (overallGainLossPercent < 0) {
                dashboardOverallGainLossPercent.classList.add('accent-red');
            } else {
                dashboardOverallGainLossPercent.classList.add('text-white');
            }
        }

        // Event listener for the "Build New Portfolio" button in the summary panel
        buildPortfolioButton.addEventListener('click', () => {
            showSection('portfolio-section');
        });


        // --- Live Chat Logic ---
        liveChatButton.addEventListener('click', () => {
            chatWindow.classList.toggle('hidden');
            if (!chatWindow.classList.contains('hidden')) {
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom
                chatInput.focus(); // Focus input when chat opens
            }
        });

        closeChatBtn.addEventListener('click', () => {
            chatWindow.classList.add('hidden');
        });

        // Function to add a message to the chat display
        function addMessageToChat(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender, sender === 'user' ? 'bg-blue-600' : 'bg-gray-700', 'text-white', 'p-2', 'rounded-lg', sender === 'user' ? 'self-end' : 'self-start', 'max-w-[80%]');
            messageDiv.textContent = message;
            chatMessagesContainer.appendChild(messageDiv);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom
        }

        // Function to send message to AI
        async function sendMessageToAI() {
            const userMessage = chatInput.value.trim();
            if (userMessage === "") return;

            addMessageToChat(userMessage, 'user');
            chatInput.value = ''; // Clear input

            // Add user message to chat history
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            // Add loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.classList.add('chat-loading-indicator', 'ai', 'bg-gray-700', 'text-white', 'p-2', 'rounded-lg', 'self-start', 'max-w-[80%]');
            loadingIndicator.textContent = 'AI is typing...';
            chatMessagesContainer.appendChild(loadingIndicator);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;

            try {
                const payload = { contents: chatHistory };
                // The API key is expected to be provided by the Canvas environment at runtime.
                // Keep it as an empty string here as per instructions.
                const apiKey = ""; // This will be automatically populated by Canvas runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                console.log("Sending payload to Gemini API:", JSON.stringify(payload));
                console.log("API URL:", apiUrl);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Check for HTTP errors first
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Gemini API HTTP error:", response.status, errorText);
                    throw new Error(`Gemini API returned an error: ${response.status} - ${errorText}`);
                }

                const text = await response.text();
console.log('🧾 Raw response:', text);

try {
  const result = JSON.parse(text);
  console.log('✅ Parsed JSON:', result);

  if (result.url) {
    window.location.href = result.url;
  } else {
    alert(result.error || 'No redirect URL received.');
  }
} catch (e) {
  console.error('❌ Failed to parse JSON:', e);
  alert('Invalid JSON from server.');
}

                console.log("Received JSON result from Gemini API:", result);

                // Remove loading indicator
                if (chatMessagesContainer.contains(loadingIndicator)) {
                    chatMessagesContainer.removeChild(loadingIndicator);
                }

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponseText = result.candidates[0].content.parts[0].text;
                    addMessageToChat(aiResponseText, 'ai');
                    chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
                } else {
                    addMessageToChat("Sorry, I couldn't get a valid response from the AI. The response structure was unexpected.", 'ai');
                    console.error("AI response structure unexpected:", result);
                }
            } catch (error) {
                // Remove loading indicator on error
                if (chatMessagesContainer.contains(loadingIndicator)) {
                    chatMessagesContainer.removeChild(loadingIndicator);
                }
                addMessageToChat("An error occurred while communicating with the AI. Please check your console for details.", 'ai');
                console.error("Error calling Gemini API:", error);
            }
        }

        sendChatBtn.addEventListener('click', sendMessageToAI);
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessageToAI();
            }
        });

        // Maximize/Minimize Panel Logic
        document.querySelectorAll('.maximize-btn').forEach(button => {
            button.addEventListener('click', function() {
                const panelId = this.dataset.panelId;
                const targetPanel = document.getElementById(panelId);
                const appContent = document.getElementById('app-content'); // Main app container
                const dashboardSection = document.getElementById('dashboard-section'); // The grid container for panels

                // Define SVG paths for plus and minus icons
                const plusIconPath = "M12 4.5v15m7.5-7.5h-15"; // Plus icon
                const minusIconPath = "M6 12h12"; // Horizontal line for "minimize"

                if (targetPanel.classList.contains('is-maximized')) {
                    // Minimize the panel
                    targetPanel.classList.remove('is-maximized');
                    appContent.classList.remove('panel-maximized-active');
                    dashboardSection.classList.remove('maximized-active');
                    this.querySelector('svg path').setAttribute('d', plusIconPath); // Change icon to plus
                } else {
                    // Maximize the panel
                    // First, minimize any other currently maximized panel
                    document.querySelectorAll('.dashboard-panel.is-maximized').forEach(maximizedPanel => {
                        maximizedPanel.classList.remove('is-maximized');
                        // Find the button within this panel and change its icon back to plus
                        const otherButton = maximizedPanel.querySelector('.maximize-btn svg path');
                        if (otherButton) {
                            otherButton.setAttribute('d', plusIconPath);
                        }
                    });

                    targetPanel.classList.add('is-maximized');
                    appContent.classList.add('panel-maximized-active');
                    dashboardSection.classList.add('maximized-active');
                    this.querySelector('svg path').setAttribute('d', minusIconPath); // Change icon to minus
                }
            });
        });

        // --- Dominant Markets Logic (New Section) ---
        async function fetchDominantMarketsData() {
            if (!dominantMarketsGrid) {
                console.error("Dominant markets grid element not found.");
                return;
            }
            marketsLoadingIndicator.classList.remove('hidden'); // Show loading indicator
            dominantMarketsGrid.innerHTML = '<div class="col-span-full text-center text-gray-400 py-4" id="markets-loading-indicator">Loading dominant market data...</div>';

            // Symbols for dominant markets: S&P 500 (SPY), Nasdaq 100 (QQQ), Dow Jones (DIA), Gold (XAUUSD), Bitcoin (BTCUSD), Ethereum (ETHUSD)
            const dominantSymbols = ["SPY", "QQQ", "DIA", "XAUUSD", "BTCUSD", "ETHUSD"];
            const marketNames = {
                "SPY": "S&P 500",
                "QQQ": "Nasdaq 100",
                "DIA": "Dow Jones",
                "XAUUSD": "Gold Spot",
                "XAGUSD": "Silver Spot", // Added Silver for completeness
                "BTCUSD": "Bitcoin",
                "ETHUSD": "Ethereum"
            };

            try {
                const quoteUrl = `${FMP_BASE_URL}/quote/${dominantSymbols.join(',')}?apikey=${FMP_API_KEY}`;
                console.log("Fetching dominant market data from:", quoteUrl); // Log the URL
                const response = await fetch(quoteUrl);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`HTTP error fetching dominant market data! Status: ${response.status}, Response: ${errorText}`);
                    throw new Error(`Failed to fetch dominant market data: ${response.status} - ${errorText}`);
                }
                const data = await response.json();
                console.log("Dominant market data received:", data);

                dominantMarketsGrid.innerHTML = ''; // Clear loading indicator and previous data

                if (data && data.length > 0) {
                    data.forEach(item => {
                        // Safely access properties, providing defaults if undefined or null
                        const price = item.price !== undefined && item.price !== null ? item.price.toFixed(2) : 'N/A';
                        const changes = item.changes !== undefined && item.changes !== null ? item.changes.toFixed(2) : 'N/A';
                        const changesPercentage = item.changesPercentage !== undefined && item.changesPercentage !== null ? item.changesPercentage.toFixed(2) : 'N/A';

                        const isPositive = parseFloat(changesPercentage) >= 0;
                        const changeClass = isPositive ? 'positive' : 'negative';
                        const arrowIcon = isPositive ?
                            `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>` :
                            `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L9 12.586V5a1 1 0 112 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`;

                        const card = document.createElement('div');
                        card.classList.add('market-card');
                        card.innerHTML = `
                            <h3>${marketNames[item.symbol] || item.symbol}</h3>
                            <p class="price">$${price}</p>
                            <div class="change ${changeClass}">
                                ${arrowIcon}
                                <span>${changes} ($)</span>
                                <span>(${changesPercentage}%)</span>
                            </div>
                        `;
                        dominantMarketsGrid.appendChild(card);
                    });
                } else {
                    dominantMarketsGrid.innerHTML = '<div class="col-span-full text-center text-gray-400 py-4">No dominant market data available.</div>';
                }
            } catch (error) {
                console.error("Error fetching dominant market data:", error);
                dominantMarketsGrid.innerHTML = `<div class="col-span-full text-center text-red-400 py-4">Failed to load market data: ${error.message}. Please check API key or network connection.</div>`;
            } finally {
                marketsLoadingIndicator.classList.add('hidden'); // Hide loading indicator
            }
        }
    </script>


<script>
  async function connectBroker() {
    const userId = 'THE-APEX-INVESTOR-USER-10';
    const userSecret = '8d7839d0-87da-419b-9048-42b4dd484c11';

    try {
      const response = await fetch('https://apex-backend-atqxi8g10-ms-projects-95c3c5e2.vercel.app/api/link-brokerage', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ userId, userSecret })
      });

      const result = await response.json();
      console.log('✅ Backend response:', result);

      if (response.ok && result.url) {
        window.location.href = result.url;
      } else {
        alert(result.error || 'No redirect URL');
      }
    } catch (error) {
      console.error('❌ Fetch error:', error);
      alert('Network or parsing error.');
    }
  }
</script>

































</body>
</html>